---
title: "IceCube SD 2025"
author: "WAK"
date: "today"
format: 
  html:
    toc: true 
    toc-float: true
    toc-location: left
---

```{r}
#| include: false
#| warning: false
#| echo: false

library(epiDisplay)
library(knitr)
library(pROC)
library(tidyverse)
library(readxl)
library(ggplot2)
library(gmodels)
library(ggbeeswarm)
library(dplyr)
library(readr)
library(ggpubr)
library(psych)
library(lme4)
library(Matrix)
library(lmerTest)
library(irr)
library(lmerTest)
library(emmeans)
library(doBy)       
library(gmodels)    
library(car)           
library(cowplot)       
library(gridGraphics)  
library(multcomp)
library(hms)
library(gt)
library(lubridate)
library(nlme)
library(extrafont)
```

## Data Steps

### Bring in Data

```{r}
#| include: false
#| warning: false
#| echo: false

lay <- read_csv('data/activity_report_1.csv')

new <- lay |>
 separate(Start, into = c("Date", "Time"), sep = " ")

unique(new$Date)
charToRaw(new$Date[1])
class(new$Date)

charToRaw(new$Time[1])

new$Date <- as.Date(as.character(new$Date), format = "%m/%d/%Y")
new$Time <- as_hms(paste0(new$Time, ":00"))


key<- read_csv("data/enroll.csv")

key<-key |> 
  mutate(Bdat=mdy(Bdat), 
         DatMOC=mdy(DatMOC), 
         DatON = mdy(DatON), 
         ToTCC = mdy(ToTCC), 
         ArrTCC = mdy(ArrTCC), 
         DatOFF = mdy(DatOFF))

all<- read_csv("data/FINAL.csv")

key <- key %>% 
  left_join(all, by = "CalfID")

key<- key %>% 
  select(Cow, CalfID, Bdat, FOO, BRTHW, stp, Breed2, diaload, diaARR, TRT, OneLoad, DatMOC, IceCube, DatON, TimeONp, ToTCC, TimetoTCCp, Section, ArrTCC, TimeArrTCCp, TimeTrip, DatOFF, TimeOFFp, PN1a, DIA1, D30, P30, P60)
```

### Merge Two Data Sets

```{r}
#| include: false
#| warning: false
#| echo: false


intersect(new$Cow, key$Cow)

combined <- new |> 
  inner_join(key, by = "Cow") %>% 
  filter(!Cow %in% c(216, 268))

#filtering out those two calves bc I can't match them on tfship as they have a loss of 1:15 to 2hrs of data around the time of shipping?

combinednew <- 
  combined |> 
  mutate(datetime = as.POSIXct(paste(Date, Time), format = "%Y-%m-%d %H:%M:%S"), 
         datetimeon = as.POSIXct(paste(DatON, TimeONp), format = "%Y-%m-%d %H:%M:%S"), 
         datetimeoff = as.POSIXct(paste (DatOFF, TimeOFFp), format = "%Y-%m-%d %H:%M:%S"))

#This filters to only times when IceCubes were on calves (128184obs to 124455obs)

use <- combinednew |> 
  filter(datetime >= datetimeon, datetime <= datetimeoff)
```

### Flagging to Trailer Entry

```{r}
#| include: false
#| warning: false
#| echo: false

#adds a variable called "match_flag" that flags when a calf was scanned to ship

use <- use |> 
  mutate(
    match_flag = if_else(
      Date == ToTCC & 
        (as.numeric(TimetoTCCp - Time, units="mins") >=0 &
        as.numeric(TimetoTCCp - Time, units = "mins") <= 14), 
      1,  
      0    )) 

#adds variable tfship, which scan to TCC time 0, all time before progressively negative, all time after progressively positive

use |> 
  group_by(Cow) |> 
  summarize(matches = list(which(match_flag == 1)))

use <- use |> 
  group_by(Cow) |>  
  mutate(
    tfship = if_else(match_flag == 1, 0, NA_integer_),  
    tfship = if_else(is.na(tfship), row_number() - which(match_flag == 1), tfship)  
  ) |> 
  ungroup()

#creates a new variable called hoursfrom which groups behaviors by hours from the second feeding. This will allow looking at the 8hrs prior to feeding and the 8 or 12 hrs later. Should probably make a new df to look at that. 

merged_data <- use |> 
  mutate(
    hoursfrom = case_when(
      tfship == 0 ~ 0,                                      
      tfship < 0 ~ as.integer((abs(tfship) - 1) %/% 4 + 1) * -1,  
      tfship > 0 ~ as.integer((tfship - 1) %/% 4 + 1)))

merged_data <- merged_data |> 
  mutate(timecat = cut(hoursfrom, 
                breaks = c(-Inf, -1, 25, Inf), 
                labels = c("pre", "during", "post")))







hour <- merged_data |> 
  group_by(Cow, hour = floor(hoursfrom)) |>  
  summarise(
    Lying = sum(`Lying Time`, na.rm = TRUE)/60,   
    Standing = sum(`Standing Time`, na.rm = TRUE)/60, 
    Steps = sum(Steps), 
    LB = sum(Transitions),
    MI = sum(`Motion Index`),
    FOO = first(FOO),              
    TRT = first(TRT),
    Breed = first(Breed2), 
    bwt = first (BRTHW), 
    diaload = first(diaload),
    sec = first (Section),
    OneLoad = first(OneLoad),
    .groups = "drop")

hour$timecat <- cut(hour$hour, 
                breaks = c(-Inf, -1, 25, Inf), 
                labels = c("pre", "during", "post"))
    

#calves were scanned in at hour ~25 so this is the end point of the "during". As there is not a way to scan calves in the trailer....

fullcut<-
merged_data %>% 
  filter(tfship >= -96 & tfship <= 200) 

write.csv(x = fullcut, file = "data/fulldatachecks.csv")

#data set that is more balanced with only calves within 1 load (exclude the 3.0sq ft carry over calves)
oneload <-
  hour %>% 
  filter (!OneLoad == 0)
  
```

## Calf Summary - Who in data set?

```{r}
#| warning: false
#| echo: false


key |> 
  group_by(TRT) |> 
  summarize (Count = n())

key %>% 
  group_by(TRT, OneLoad) %>% 
  summarize (count = n())
 
key |> 
  group_by(Section) |> 
  summarize (Count = n())

key |> 
  group_by(TRT, FOO) |> 
  summarize(Count = n())

key |> 
  group_by(TRT, Section) |> 
  summarize (Count = n())


key |> 
  group_by(TRT) |> 
  summarize (Count = n(), 
             mean = mean(TimeTrip), 
             sd = sd(TimeTrip))

key$TRT <- relevel(factor(key$TRT), ref = "DF3.0")
lm_bw <- lm(TimeTrip ~ TRT, data=key)
summary(lm_bw)


  
  

```

## Data Investigation

```{r}


hour %>% 
  filter(hour >= -24 & hour <= 50) %>% 
  ggplot(aes(x=hour, y=Lying, color = factor(Cow), group = Cow))+
         geom_line (aes(fill = Cow), size = 1, alpha = 0.1)+
         geom_point()+ 
         theme_minimal()


hour %>% 
  filter(hour >= -24 & hour <= 50) %>% 
  group_by(TRT) %>% 
  summarize(
    lay = mean(Lying),
    laysd = sd(Lying),
    stand = mean(Standing),
    standsd = sd(Standing),
    steps = mean(Steps), 
    lb = mean(LB),
    mi = mean(MI)
  )


hour %>% 
  filter(hour >= -24 & hour <= 50) %>% 
  group_by(TRT, timecat) %>% 
  summarize(
    lay = mean(Lying),
    laysd = sd(Lying),
    stand = mean(Standing),
    standsd = sd(Standing),
    steps = mean(Steps), 
    lb = mean(LB),
    mi = mean(MI)
  )



hour |> 
  ggplot(aes (x = Lying))+
  geom_histogram()

hour |> 
  ggplot(aes (x = Standing))+
  geom_histogram()

hour |> 
  ggplot(aes (x = Steps))+
  geom_histogram()

hour |> 
  ggplot(aes (x = LB))+
  geom_histogram()



hourcut <-
  hour %>% 
  filter(hour >= -24 & hour <= 50)
write.csv(x = hourcut, file = "data/hourdatachecks.csv")
```

#### Plots by Time Category

```{r}

ggplot(hour, aes(x = TRT, y = Lying, color = TRT)) +
  geom_boxplot(outlier.shape = NA) +
  facet_wrap(vars(timecat)) +
  geom_jitter() +
    theme_classic()

hour$Lying_hr <- as.numeric(hour$Lying, units = "secs")
lm_lay <-lm(Lying_hr ~TRT*timecat, data=hour)
summary(lm_lay)
emmeans(lm_lay, ~TRT|timecat)
#plot(lm_lay)


ggplot(hour, aes(x = TRT, y = Standing, color = TRT)) +
  geom_boxplot(outlier.shape = NA) +
  facet_wrap(vars(timecat)) +
  geom_jitter() +
    theme_classic()

hour$stand <- as.numeric(hour$Standing, units = "secs")
lm_s <-lm(stand ~TRT*timecat, data=hour)
summary(lm_s)
emmeans(lm_s, ~TRT|timecat)
#plot(lm_s)


ggplot(hour, aes(x = TRT, y = Steps, color = TRT)) +
  geom_boxplot(outlier.shape = NA) +
  facet_wrap(vars(timecat)) +
  geom_jitter() +
    theme_classic()


lm_st <-lm(Steps ~TRT*timecat, data=hour)
summary(lm_st)
emmeans(lm_st, ~TRT|timecat)
#plot(lm_s)



ggplot(hour, aes(x = TRT, y = LB, color = TRT)) +
  geom_boxplot(outlier.shape = NA) +
  facet_wrap(vars(timecat)) +
  geom_jitter() +
    theme_classic()

lm_lb <-lm(LB ~TRT*timecat, data=hour)
summary(lm_lb)
emmeans(lm_lb, ~TRT|timecat)
#plot(lm_s)


ggplot(hour, aes(x = TRT, y = MI, color = TRT)) +
  geom_boxplot(outlier.shape = NA) +
  facet_wrap(vars(timecat)) +
  geom_jitter() +
    theme_classic()


lm_mi <-lm(MI ~TRT*timecat, data=hour)
summary(lm_mi)
emmeans(lm_mi, ~TRT|timecat)
#plot(lm_s)



```

#### Plot to sus out 3.5sf

```{r}


hourcut %>% 
  filter(hour >= 28 & hour <= 50) %>% 
  filter(timecat == "post") %>% 
  filter(TRT == "DF3.5") %>% 
  ggplot(aes(x=hour, y=Lying, color = factor(Cow), group = Cow))+
         geom_line (aes(fill = Cow), size = 1, alpha = 0.1)+
         geom_point()+ 
         theme_minimal()


hourcut %>% 
  filter(hour >= 28 & hour <= 50) %>% 
  filter(timecat == "post") %>% 
  filter(TRT == "DF3.0") %>% 
  ggplot(aes(x=hour, y=Lying, color = factor(Cow), group = Cow))+
         geom_line (aes(fill = Cow), size = 1, alpha = 0.1)+
         geom_point()+ 
         theme_minimal()


hourcut %>% 
  filter(hour >= 28 & hour <= 50) %>% 
  filter(timecat == "post") %>% 
  filter(TRT == "DF4.5") %>% 
  ggplot(aes(x=hour, y=Lying, color = factor(Cow), group = Cow))+
         geom_line (aes(fill = Cow), size = 1, alpha = 0.1)+
         geom_point()+ 
         theme_minimal()



#From these graphs it looks like the 3.5sd group had their icequbes removed as they came off the truck and/or soon after they arrived. There is enough variation in the other calves that it looks OK. 

#How do I sus this out further? Sum for each calf? 

df3.5 <- hourcut %>% 
   filter(hour >= 29 & hour <= 50) %>%
  filter(timecat == "post") %>% 
  filter(TRT == "DF3.5") %>% 
  group_by(Cow) %>% 
  summarize(
    lay = sum(Lying), 
    lay1 = sum(Lying)/22)

df3.5

dfall <- hourcut %>% 
   filter(hour >= 31 & hour <= 40) %>%
  filter(timecat == "post") %>% 
  group_by(Cow) %>% 
  summarize(
    lay = sum(Lying), 
    lay1 = sum(Lying)/10)

dfall


write.csv(x = df3.5, file = "data/3.5calves.csv" )
write.csv(x = dfall, file = "data/postcalves.csv" )
#Then, if the summarized is 60 we can assume that the data is crap? 
#look at this further, how many calves look like they have reliable data? 

target_calf<- c(233,199,245,211,236,235,198,260,237,262,190,192,244,241,228,219,197,204,225,252,196,191,207,229,227,189,193,214,217,222,226,230,231,234,239,246,249,250)

hour_clean <- hourcut %>%
  filter(!Cow %in% target_calf & hour>=29)

hour_clean %>% 
  filter(hour >= 28 & hour <= 50) %>% 
  filter(timecat == "post") %>% 
  filter(TRT == "DF3.5") %>% 
  ggplot(aes(x=hour, y=Lying, color = factor(Cow), group = Cow))+
         geom_line (aes(fill = Cow), size = 1, alpha = 0.1)+
         geom_point()+ 
         theme_minimal()


hour_clean %>% 
  filter(hour >= 28 & hour <= 50) %>% 
  filter(timecat == "post") %>% 
  filter(TRT == "DF3.0") %>% 
  ggplot(aes(x=hour, y=Lying, color = factor(Cow), group = Cow))+
         geom_line (aes(fill = Cow), size = 1, alpha = 0.1)+
         geom_point()+ 
         theme_minimal()


hour_clean %>% 
  filter(hour >= 28 & hour <= 50) %>% 
  filter(timecat == "post") %>% 
  filter(TRT == "DF4.5") %>% 
  ggplot(aes(x=hour, y=Lying, color = factor(Cow), group = Cow))+
         geom_line (aes(fill = Cow), size = 1, alpha = 0.1)+
         geom_point()+ 
         theme_minimal()


```

#### Change in Merged Data to pull out all weird calves (n=69 calves)

```{r}
#| warning: false
#| echo: false

#target_calf<- c(169,171,177,182,184,186,188,212,203,254,233,132,202,232,247,195,220,258,218,243,238,210,355,144,167,168,170,173,174,175,176,179,180,181,183,185,187,189,191,192,193,198,199,204,207,213,214,217,219,222,225,226,227,228,229,230,231,234,237,239,245,246,249,250,251,252,260,262,283)

#merged_data_f <- merged_data %>%
#  filter (!(Cow %in% target_calf))
```

## Hour

### Overall + By TRT

#### Laying

```{r}
#| warning: false
#| echo: false


laying <- merged_data |> 
  filter(hoursfrom >= -16 & hoursfrom <= 50) |>
  group_by(Cow, hoursfrom, timecat) |>  
  summarize(
    `Lying Time` = sum(`Lying Time`, na.rm = TRUE)) |> 
  group_by(hoursfrom) |>  
  summarize(
    `Lying Time` = mean(`Lying Time`, na.rm = TRUE)) |> 
  mutate(
    lyingm = `Lying Time` / 60) |> 
  ungroup()


laying |> 
ggplot(aes(x = hoursfrom, y = lyingm)) +
  theme_classic() +
  geom_point() +  
  geom_line() +   
  labs(
    title = "Lying Time in the 48hrs around long haul transport",
    x = "Hours from Trip Start",
    y = "Lying Time (min)")+
    scale_y_continuous(limits = c(0, 60), breaks = seq(0, 60, by = 5))+
    scale_x_continuous(limits = c(-16, 50), breaks = seq(-16, 50, by = 8))



laying2 <- merged_data |> 
  filter(hoursfrom >= -16 & hoursfrom <= 50) |> 
  group_by(Cow, hoursfrom, TRT) |>  
  summarize(
    `Lying Time` = sum(`Lying Time`, na.rm = TRUE)) |> 
  group_by(hoursfrom, TRT) |>  
  summarize(
    `Lying Time` = mean(`Lying Time`, na.rm = TRUE)) |> 
  mutate(
    lyingm = `Lying Time` / 60) |> 
  ungroup()


laying2 |> 
ggplot(aes(x = hoursfrom, y = lyingm, color=TRT)) +
  theme_classic() +
  geom_point() +  
  geom_line() +   
  labs(
    title = "Lying Time in the 48hrs around long haul transport",
    x = "Hours from Trip Start",
    y = "Lying Time (min)")+
    scale_y_continuous(limits = c(0, 60), breaks = seq(0, 60, by = 5))+
    scale_x_continuous(limits = c(-16, 50), breaks = seq(-16, 50, by = 8))

laying2_f <- merged_data_f |> 
  filter(hoursfrom >= -16 & hoursfrom <= 50) |> 
  group_by(Cow, hoursfrom, TRT) |>  
  summarize(
    `Lying Time` = sum(`Lying Time`, na.rm = TRUE)) |> 
  group_by(hoursfrom, TRT) |>  
  summarize(
    `Lying Time` = mean(`Lying Time`, na.rm = TRUE)) |> 
  mutate(
    lyingm = `Lying Time` / 60) |> 
  ungroup()


laying2_f |> 
ggplot(aes(x = hoursfrom, y = lyingm, color=TRT)) +
  theme_classic() +
  geom_point() +  
  geom_line() +   
  labs(
    title = "Lying Time in the 48hrs around long haul transport",
    x = "Hours from Trip Start",
    y = "Lying Time (min)")+
    scale_y_continuous(limits = c(0, 60), breaks = seq(0, 60, by = 5))+
    scale_x_continuous(limits = c(-16, 50), breaks = seq(-16, 50, by = 8))


laying3 <- merged_data |> 
  filter(hoursfrom >= -24 & hoursfrom <= 50) |> 
  group_by(Cow, hoursfrom, Section) |>  
  summarize(
    `Lying Time` = sum(`Lying Time`, na.rm = TRUE)) |> 
  group_by(hoursfrom, Section) |>  
  summarize(
    `Lying Time` = mean(`Lying Time`, na.rm = TRUE)) |> 
  mutate(
    lyingm = `Lying Time` / 60) |> 
  ungroup()


laying3 |> 
ggplot(aes(x = hoursfrom, y = lyingm, color=Section)) +
  theme_classic() +
  geom_point() +  
  geom_line() +   
  labs(
    title = "Lying Time in the 48hrs around long haul transport",
    x = "Hours from Trip Start",
    y = "Lying Time (min)")+
    scale_y_continuous(limits = c(0, 60), breaks = seq(0, 60, by = 5))+
    scale_x_continuous(limits = c(-16, 50), breaks = seq(-16, 50, by = 8))


#for checks to make sure categories are correct: 

laying2 <- merged_data |> 
  filter(hoursfrom >= 20 & hoursfrom <= 30) |> 
  group_by(Cow, hoursfrom, TRT) |>  
  summarize(
    `Lying Time` = sum(`Lying Time`, na.rm = TRUE)) |> 
  group_by(hoursfrom, TRT) |>  
  summarize(
    `Lying Time` = mean(`Lying Time`, na.rm = TRUE)) |> 
  mutate(
    lyingm = `Lying Time` / 60) |> 
  ungroup()


laying2 |> 
ggplot(aes(x = hoursfrom, y = lyingm, color=TRT)) +
  theme_classic() +
  geom_point() +  
  geom_line() +   
  labs(
    title = "Lying Time in the 48hrs around long haul transport",
    x = "Hours from Trip Start",
    y = "Lying Time (min)")+
    scale_y_continuous(limits = c(0, 60), breaks = seq(0, 60, by = 5))+
    scale_x_continuous(limits = c(20, 30), breaks = seq(20, 30, by = 1))



laying2 <- merged_data |> 
  filter(hoursfrom >= -5 & hoursfrom <= 5) |> 
  group_by(Cow, hoursfrom, TRT) |>  
  summarize(
    `Lying Time` = sum(`Lying Time`, na.rm = TRUE)) |> 
  group_by(hoursfrom, TRT) |>  
  summarize(
    `Lying Time` = mean(`Lying Time`, na.rm = TRUE)) |> 
  mutate(
    lyingm = `Lying Time` / 60) |> 
  ungroup()


laying2 |> 
ggplot(aes(x = hoursfrom, y = lyingm, color=TRT)) +
  theme_classic() +
  geom_point() +  
  geom_line() +   
  labs(
    title = "Lying Time in the 48hrs around long haul transport",
    x = "Hours from Trip Start",
    y = "Lying Time (min)")+
    scale_y_continuous(limits = c(0, 60), breaks = seq(0, 60, by = 5))+
    scale_x_continuous(limits = c(-5, 5), breaks = seq(-5, 5, by = 1))






```

#### Standing

```{r}
#| warning: false
#| echo: false

standing <- merged_data |> 
  filter(hoursfrom >= -16 & hoursfrom <= 50) |> 
  group_by(Cow, hoursfrom) |>  
  summarize(
    `Standing Time` = sum(`Standing Time`, na.rm = TRUE)) |> 
  group_by(hoursfrom) |>  
  summarize(
    `Standing Time` = mean(`Standing Time`, na.rm = TRUE)) |> 
  mutate(
    standm = `Standing Time` / 60) |> 
  ungroup()


standing |> 
ggplot(aes(x = hoursfrom, y = standm)) +
  theme_classic() +
  geom_point() +  
  geom_line() +   
  labs(
    title = "Standing Time in the 48hrs around transportation",
    x = "Hours from Transport",
    y = "Standing Time (min)") +
    scale_y_continuous(limits = c(0, 60), breaks = seq(0, 60, by = 5))+
    scale_x_continuous(limits = c(-16, 50), breaks = seq(-16, 50, by = 6))



standing2 <- merged_data |> 
  filter(hoursfrom >= -12 & hoursfrom <= 40) |> 
  group_by(Cow, hoursfrom, TRT) |>  
  summarize(
    `Standing Time` = sum(`Standing Time`, na.rm = TRUE)) |> 
  group_by(hoursfrom, TRT) |>  
  summarize(
    `Standing Time` = mean(`Standing Time`, na.rm = TRUE)) |> 
  mutate(
    standm = `Standing Time` / 60) |> 
  ungroup()


standing2 |> 
ggplot(aes(x = hoursfrom, y = standm, color=TRT)) +
  theme_classic() +
  geom_point() +  
  geom_line() +   
  labs(
    title = "Standing Time in the 48hrs around transportation",
    x = "Hours from Transport",
    y = "Standing Time (min)") +
    scale_y_continuous(limits = c(0, 60), breaks = seq(0, 60, by = 5))+
    scale_x_continuous(limits = c(-16, 50), breaks = seq(-16, 50, by = 6))



standing2_f <- merged_data_f |> 
  filter(hoursfrom >= -12 & hoursfrom <= 40) |> 
  group_by(Cow, hoursfrom, TRT) |>  
  summarize(
    `Standing Time` = sum(`Standing Time`, na.rm = TRUE)) |> 
  group_by(hoursfrom, TRT) |>  
  summarize(
    `Standing Time` = mean(`Standing Time`, na.rm = TRUE)) |> 
  mutate(
    standm = `Standing Time` / 60) |> 
  ungroup()


standing2_f |> 
ggplot(aes(x = hoursfrom, y = standm, color=TRT)) +
  theme_classic() +
  geom_point() +  
  geom_line() +   
  labs(
    title = "Standing Time in the 48hrs around transportation",
    x = "Hours from Transport",
    y = "Standing Time (min)") +
    scale_y_continuous(limits = c(0, 60), breaks = seq(0, 60, by = 5))+
    scale_x_continuous(limits = c(-12, 40), breaks = seq(-12, 40, by = 6))


```

#### Steps

```{r}
#| warning: false
#| echo: false

stepgrp <- merged_data |> 
  filter(hoursfrom >= -16 & hoursfrom <= 50) |> 
  group_by(Cow, hoursfrom) |>  
  summarize(
    `Steps` = sum(`Steps`, na.rm = TRUE)) |> 
  group_by(hoursfrom) |>  
  summarize(
    steps = mean(`Steps`, na.rm = TRUE)) |> 
  ungroup()


stepgrp |> 
ggplot(aes(x = hoursfrom, y = steps)) +
  theme_classic() +
  geom_point() +  
  geom_line() +   
  labs(
    title = "Steps in the 48hrs around transportation",
    x = "Hours from Transport",
    y = "Steps(n)") +
    scale_y_continuous(limits = c(0, 200), breaks = seq(0, 200, by = 50))+
    scale_x_continuous(limits = c(-16, 50), breaks = seq(-16, 50, by = 8))



stepgrp <- merged_data |> 
  filter(hoursfrom >= -16 & hoursfrom <= 50) |> 
  group_by(Cow, hoursfrom, TRT) |>  
  summarize(
    `Steps` = sum(`Steps`, na.rm = TRUE)) |> 
  group_by(hoursfrom, TRT) |>  
  summarize(
    steps = mean(`Steps`, na.rm = TRUE)) |> 
  ungroup()


stepgrp |> 
ggplot(aes(x = hoursfrom, y = steps, color=TRT)) +
  theme_classic() +
  geom_point() +  
  geom_line() +   
  labs(
    title = "Steps in the 48hrs around transportation",
    x = "Hours from Transport",
    y = "Steps(n)") +
    scale_y_continuous(limits = c(0, 200), breaks = seq(0, 200, by = 50))+
    scale_x_continuous(limits = c(-16, 50), breaks = seq(-16, 50, by = 8))


stepgrp_f <- merged_data_f |> 
  filter(hoursfrom >= -16 & hoursfrom <= 50) |> 
  group_by(Cow, hoursfrom, TRT) |>  
  summarize(
    `Steps` = sum(`Steps`, na.rm = TRUE)) |> 
  group_by(hoursfrom, TRT) |>  
  summarize(
    steps = mean(`Steps`, na.rm = TRUE)) |> 
  ungroup()


stepgrp_f |> 
ggplot(aes(x = hoursfrom, y = steps, color=TRT)) +
  theme_classic() +
  geom_point() +  
  geom_line() +   
  labs(
    title = "Steps in the 48hrs around transportation",
    x = "Hours from Transport",
    y = "Steps(n)") +
    scale_y_continuous(limits = c(0, 200), breaks = seq(0, 200, by = 50))+
    scale_x_continuous(limits = c(-16, 50), breaks = seq(-16, 50, by = 8))

```

#### Transitions

```{r}
#| warning: false
#| echo: false

lbgrp <- merged_data |> 
  filter(hoursfrom >= -16 & hoursfrom <= 50) |> 
  group_by(Cow, hoursfrom) |>  
  summarize(
    `Transitions` = sum(`Transitions`, na.rm = TRUE)) |> 
  group_by(hoursfrom) |>  
  summarize(
    lb = mean(`Transitions`, na.rm = TRUE)) |> 
  ungroup()


lbgrp |> 
ggplot(aes(x = hoursfrom, y = lb)) +
  theme_classic() +
  geom_point() +  
  geom_line() +   
  labs(
    title = "Transitions (LB) in the 48hrs around transportation",
    x = "Hours from Transport",
    y = "Transitions(n)") +
    scale_y_continuous(limits = c(0, 8), breaks = seq(0, 8, by = 2))+
    scale_x_continuous(limits = c(-16, 50), breaks = seq(-16, 50, by = 8))



stepgrp2 <- merged_data |> 
  filter(hoursfrom >= -16 & hoursfrom <= 50) |> 
  group_by(Cow, hoursfrom, TRT) |>  
  summarize(
    `Transitions` = sum(`Transitions`, na.rm = TRUE)) |> 
  group_by(hoursfrom, TRT) |>  
  summarize(
    lb = mean(`Transitions`, na.rm = TRUE)) |> 
  ungroup()


stepgrp2 |> 
ggplot(aes(x = hoursfrom, y = lb, color=TRT)) +
  theme_classic() +
  geom_point() +  
  geom_line() +   
  labs(
    title = "Transitions in the 48hrs around transportation",
    x = "Hours from Transport",
    y = "Transitions(n)") +
    scale_y_continuous(limits = c(0, 8), breaks = seq(0, 8, by = 2))+
    scale_x_continuous(limits = c(-16, 50), breaks = seq(-16, 50, by = 8))



stepgrp2_f <- merged_data_f |> 
  filter(hoursfrom >= -16 & hoursfrom <= 50) |> 
  group_by(Cow, hoursfrom, TRT) |>  
  summarize(
    `Transitions` = sum(`Transitions`, na.rm = TRUE)) |> 
  group_by(hoursfrom, TRT) |>  
  summarize(
    lb = mean(`Transitions`, na.rm = TRUE)) |> 
  ungroup()


stepgrp2_f |> 
ggplot(aes(x = hoursfrom, y = lb, color=TRT)) +
  theme_classic() +
  geom_point() +  
  geom_line() +   
  labs(
    title = "Transitions in the 48hrs around transportation",
    x = "Hours from Transport",
    y = "Transitions(n)") +
    scale_y_continuous(limits = c(0, 8), breaks = seq(0, 8, by = 2))+
    scale_x_continuous(limits = c(-16, 50), breaks = seq(-16, 50, by = 8))
```

#### Motion Index

```{r}
#| warning: false
#| echo: false

migrp <- merged_data |> 
  filter(hoursfrom >= -16 & hoursfrom <= 50) |> 
  group_by(Cow, hoursfrom) |>  
  summarize(
    `Motion Index` = sum(`Motion Index`, na.rm = TRUE)) |> 
  group_by(hoursfrom) |>  
  summarize(
    mi = mean(`Motion Index`, na.rm = TRUE)) |> 
  ungroup()


migrp |> 
ggplot(aes(x = hoursfrom, y = mi)) +
  theme_classic() +
  geom_point() +  
  geom_line() +   
  labs(
    title = "Motion Index in the 48hrs around transportation",
    x = "Hours from Transport",
    y = "MI") +
    scale_y_continuous(limits = c(0, 1000), breaks = seq(0, 1000, by = 250))+
    scale_x_continuous(limits = c(-16, 50), breaks = seq(-16, 50, by = 8))



migrp2 <- merged_data |> 
  filter(hoursfrom >= -16 & hoursfrom <= 50) |> 
  group_by(Cow, hoursfrom, TRT) |>  
  summarize(
    `Motion Index` = sum(`Motion Index`, na.rm = TRUE)) |> 
  group_by(hoursfrom, TRT) |>  
  summarize(
    mi = mean(`Motion Index`, na.rm = TRUE)) |> 
  ungroup()


migrp2 |> 
ggplot(aes(x = hoursfrom, y = mi, color=TRT)) +
  theme_classic() +
  geom_point() +  
  geom_line() +   
  labs(
    title = "Motion Index the 48hrs around transportation",
    x = "Hours from Transport",
    y = "MI") +
    scale_y_continuous(limits = c(0, 1000), breaks = seq(0, 1000, by = 250))+
    scale_x_continuous(limits = c(-16, 50), breaks = seq(-16, 50, by = 10))


migrp2_f <- merged_data_f |> 
  filter(hoursfrom >= -16 & hoursfrom <= 50) |> 
  group_by(Cow, hoursfrom, TRT) |>  
  summarize(
    `Motion Index` = sum(`Motion Index`, na.rm = TRUE)) |> 
  group_by(hoursfrom, TRT) |>  
  summarize(
    mi = mean(`Motion Index`, na.rm = TRUE)) |> 
  ungroup()


migrp2_f |> 
ggplot(aes(x = hoursfrom, y = mi, color=TRT)) +
  theme_classic() +
  geom_point() +  
  geom_line() +   
  labs(
    title = "Motion Index the 48hrs around transportation",
    x = "Hours from Transport",
    y = "MI") +
    scale_y_continuous(limits = c(0, 1000), breaks = seq(0, 1000, by = 250))+
    scale_x_continuous(limits = c(-16, 50), breaks = seq(-16, 50, by = 10))






#data checks, when to parse the data
migrp2 <- merged_data |> 
  filter(hoursfrom >= 25 & hoursfrom <= 30) |> 
  group_by(Cow, hoursfrom, TRT) |>  
  summarize(
    `Motion Index` = sum(`Motion Index`, na.rm = TRUE)) |> 
  group_by(hoursfrom, TRT) |>  
  summarize(
    mi = mean(`Motion Index`, na.rm = TRUE)) |> 
  ungroup()


migrp2 |> 
ggplot(aes(x = hoursfrom, y = mi, color=TRT)) +
  theme_classic() +
  geom_point() +  
  geom_line() +   
  labs(
    title = "Motion Index the 48hrs around transportation",
    x = "Hours from Transport",
    y = "MI") +
    scale_y_continuous(limits = c(0, 1000), breaks = seq(0, 1000, by = 250))+
    scale_x_continuous(limits = c(25, 30), breaks = seq(25, 30, by = 1))




```

## Hour - One Load

### Overall + By TRT

#### Laying

```{r}
#| warning: false
#| echo: false


laying <- merged_data |> 
  filter(OneLoad == 1)|>
  filter(hoursfrom >= -16 & hoursfrom <= 50) |> 
  group_by(Cow, hoursfrom) |>  
  summarize(
    `Lying Time` = sum(`Lying Time`, na.rm = TRUE)) |> 
  group_by(hoursfrom) |>  
  summarize(
    `Lying Time` = mean(`Lying Time`, na.rm = TRUE)) |> 
  mutate(
    lyingm = `Lying Time` / 60) |> 
  ungroup()



laying |> 
ggplot(aes(x = hoursfrom, y = lyingm)) +
  theme_classic() +
  geom_point() +  
  geom_line() +   
  labs(
    title = "Lying Time in the 48hrs around long haul transport",
    x = "Hours from Trip Start",
    y = "Lying Time (min)")+
    scale_y_continuous(limits = c(0, 60), breaks = seq(0, 60, by = 5))+
    scale_x_continuous(limits = c(-16, 50), breaks = seq(-16, 50, by = 8))



laying2 <- merged_data |> 
  filter(OneLoad == 1)|>
  filter(hoursfrom >= -16 & hoursfrom <= 50) |> 
  group_by(Cow, hoursfrom, TRT) |>  
  summarize(
    `Lying Time` = sum(`Lying Time`, na.rm = TRUE)) |> 
  group_by(hoursfrom, TRT) |>  
  summarize(
    `Lying Time` = mean(`Lying Time`, na.rm = TRUE)) |> 
  mutate(
    lyingm = `Lying Time` / 60) |> 
  ungroup()


laying2 |> 
ggplot(aes(x = hoursfrom, y = lyingm, color=TRT)) +
  theme_classic() +
  geom_point() +  
  geom_line() +   
  labs(
    title = "Lying Time in the 48hrs around long haul transport",
    x = "Hours from Trip Start",
    y = "Lying Time (min)")+
    scale_y_continuous(limits = c(0, 60), breaks = seq(0, 60, by = 5))+
    scale_x_continuous(limits = c(-16, 50), breaks = seq(-16, 50, by = 8))


laying3 <- merged_data |> 
  filter(OneLoad == 1)|>
  filter(hoursfrom >= -16 & hoursfrom <= 50) |> 
  group_by(Cow, hoursfrom, Section) |>  
  summarize(
    `Lying Time` = sum(`Lying Time`, na.rm = TRUE)) |> 
  group_by(hoursfrom, Section) |>  
  summarize(
    `Lying Time` = mean(`Lying Time`, na.rm = TRUE)) |> 
  mutate(
    lyingm = `Lying Time` / 60) |> 
  ungroup()


laying3 |> 
ggplot(aes(x = hoursfrom, y = lyingm, color=Section)) +
  theme_classic() +
  geom_point() +  
  geom_line() +   
  labs(
    title = "Lying Time in the 48hrs around long haul transport",
    x = "Hours from Trip Start",
    y = "Lying Time (min)")+
    scale_y_continuous(limits = c(0, 60), breaks = seq(0, 60, by = 5))+
    scale_x_continuous(limits = c(-16, 50), breaks = seq(-16, 50, by = 8))


```

#### Standing

```{r}
#| warning: false
#| echo: false

standing <- merged_data |> 
    filter(OneLoad == 1)|>
  filter(hoursfrom >= -16 & hoursfrom <= 50) |> 
  group_by(Cow, hoursfrom) |>  
  summarize(
    `Standing Time` = sum(`Standing Time`, na.rm = TRUE)) |> 
  group_by(hoursfrom) |>  
  summarize(
    `Standing Time` = mean(`Standing Time`, na.rm = TRUE)) |> 
  mutate(
    standm = `Standing Time` / 60) |> 
  ungroup()


standing |> 
ggplot(aes(x = hoursfrom, y = standm)) +
  theme_classic() +
  geom_point() +  
  geom_line() +   
  labs(
    title = "Standing Time in the 48hrs around transportation",
    x = "Hours from Transport",
    y = "Standing Time (min)") +
    scale_y_continuous(limits = c(0, 60), breaks = seq(0, 60, by = 5))+
    scale_x_continuous(limits = c(-16, 50), breaks = seq(-16, 50, by = 8))



standing2 <- merged_data |> 
    filter(OneLoad == 1)|>
  filter(hoursfrom >= -16 & hoursfrom <= 50) |> 
  group_by(Cow, hoursfrom, TRT) |>  
  summarize(
    `Standing Time` = sum(`Standing Time`, na.rm = TRUE)) |> 
  group_by(hoursfrom, TRT) |>  
  summarize(
    `Standing Time` = mean(`Standing Time`, na.rm = TRUE)) |> 
  mutate(
    standm = `Standing Time` / 60) |> 
  ungroup()


standing2 |> 
ggplot(aes(x = hoursfrom, y = standm, color=TRT)) +
  theme_classic() +
  geom_point() +  
  geom_line() +   
  labs(
    title = "Standing Time in the 48hrs around transportation",
    x = "Hours from Transport",
    y = "Standing Time (min)") +
    scale_y_continuous(limits = c(0, 60), breaks = seq(0, 60, by = 5))+
    scale_x_continuous(limits = c(-16, 50), breaks = seq(-16, 50, by = 6))




```

#### Steps

```{r}
#| warning: false
#| echo: false

stepgrp <- merged_data |> 
    filter(OneLoad == 1)|>
  filter(hoursfrom >= -16 & hoursfrom <= 50) |> 
  group_by(Cow, hoursfrom) |>  
  summarize(
    `Steps` = sum(`Steps`, na.rm = TRUE)) |> 
  group_by(hoursfrom) |>  
  summarize(
    steps = mean(`Steps`, na.rm = TRUE)) |> 
  ungroup()


stepgrp |> 
ggplot(aes(x = hoursfrom, y = steps)) +
  theme_classic() +
  geom_point() +  
  geom_line() +   
  labs(
    title = "Steps in the 48hrs around transportation",
    x = "Hours from Transport",
    y = "Steps(n)") +
    scale_y_continuous(limits = c(0, 200), breaks = seq(0, 200, by = 50))+
    scale_x_continuous(limits = c(-16, 50), breaks = seq(-16, 50, by = 8))



stepgrp <- merged_data |> 
    filter(OneLoad == 1)|>
  filter(hoursfrom >= -16 & hoursfrom <= 50) |> 
  group_by(Cow, hoursfrom, TRT) |>  
  summarize(
    `Steps` = sum(`Steps`, na.rm = TRUE)) |> 
  group_by(hoursfrom, TRT) |>  
  summarize(
    steps = mean(`Steps`, na.rm = TRUE)) |> 
  ungroup()


stepgrp |> 
ggplot(aes(x = hoursfrom, y = steps, color=TRT)) +
  theme_classic() +
  geom_point() +  
  geom_line() +   
  labs(
    title = "Steps in the 48hrs around transportation",
    x = "Hours from Transport",
    y = "Steps(n)") +
    scale_y_continuous(limits = c(0, 200), breaks = seq(0, 200, by = 50))+
    scale_x_continuous(limits = c(-16, 50), breaks = seq(-16, 50, by = 8))



```

#### Transitions

```{r}
#| warning: false
#| echo: false

lbgrp <- merged_data |> 
     filter(OneLoad == 1)|>
  filter(hoursfrom >= -16 & hoursfrom <= 50) |> 
  group_by(Cow, hoursfrom) |>  
  summarize(
    `Transitions` = sum(`Transitions`, na.rm = TRUE)) |> 
  group_by(hoursfrom) |>  
  summarize(
    lb = mean(`Transitions`, na.rm = TRUE)) |> 
  ungroup()


lbgrp |> 
ggplot(aes(x = hoursfrom, y = lb)) +
  theme_classic() +
  geom_point() +  
  geom_line() +   
  labs(
    title = "Transitions (LB) in the 48hrs around transportation",
    x = "Hours from Transport",
    y = "Transitions(n)") +
    scale_y_continuous(limits = c(0, 8), breaks = seq(0, 8, by = 2))+
    scale_x_continuous(limits = c(-16, 50), breaks = seq(-16, 50, by = 8))



stepgrp2 <- merged_data |> 
     filter(OneLoad == 1)|>
  filter(hoursfrom >= -16 & hoursfrom <= 50) |> 
  group_by(Cow, hoursfrom, TRT) |>  
  summarize(
    `Transitions` = sum(`Transitions`, na.rm = TRUE)) |> 
  group_by(hoursfrom, TRT) |>  
  summarize(
    lb = mean(`Transitions`, na.rm = TRUE)) |> 
  ungroup()


stepgrp2 |> 
ggplot(aes(x = hoursfrom, y = lb, color=TRT)) +
  theme_classic() +
  geom_point() +  
  geom_line() +   
  labs(
    title = "Transitions in the 48hrs around transportation",
    x = "Hours from Transport",
    y = "Transitions(n)") +
    scale_y_continuous(limits = c(0, 8), breaks = seq(0, 8, by = 2))+
    scale_x_continuous(limits = c(-16, 50), breaks = seq(-16, 50, by = 8))
```

#### Motion Index

```{r}
#| warning: false
#| echo: false

migrp <- merged_data |> 
     filter(OneLoad == 1)|>
  filter(hoursfrom >= -24 & hoursfrom <= 50) |> 
  group_by(Cow, hoursfrom) |>  
  summarize(
    `Motion Index` = sum(`Motion Index`, na.rm = TRUE)) |> 
  group_by(hoursfrom) |>  
  summarize(
    mi = mean(`Motion Index`, na.rm = TRUE)) |> 
  ungroup()


migrp |> 
ggplot(aes(x = hoursfrom, y = mi)) +
  theme_classic() +
  geom_point() +  
  geom_line() +   
  labs(
    title = "Motion Index in the 48hrs around transportation",
    x = "Hours from Transport",
    y = "MI") +
    scale_y_continuous(limits = c(0, 1000), breaks = seq(0, 1000, by = 250))+
    scale_x_continuous(limits = c(-16, 50), breaks = seq(-16, 50, by = 8))



migrp2 <- merged_data |> 
     filter(OneLoad == 1)|>
  filter(hoursfrom >= -24 & hoursfrom <= 50) |> 
  group_by(Cow, hoursfrom, TRT) |>  
  summarize(
    `Motion Index` = sum(`Motion Index`, na.rm = TRUE)) |> 
  group_by(hoursfrom, TRT) |>  
  summarize(
    mi = mean(`Motion Index`, na.rm = TRUE)) |> 
  ungroup()


migrp2 |> 
ggplot(aes(x = hoursfrom, y = mi, color=TRT)) +
  theme_classic() +
  geom_point() +  
  geom_line() +   
  labs(
    title = "MI in the 48hrs around transportation",
    x = "Hours from Transport",
    y = "Motion Index(n)") +
    scale_y_continuous(limits = c(0, 1000), breaks = seq(0, 1000, by = 250))+
    scale_x_continuous(limits = c(-24, 50), breaks = seq(-24, 50, by = 8))
```

## Models - One Load

#### New Data Set

This analysis data set includes data from calves 12 hours before (-12) to 12 hours after (26h + 12h = 38h) travel. Can tweak as needed, but I am not confident about the quality of the data post arrival as it looks like the 3.5DF were removed about hour 30 (4h after arrival) . We can do 24h as well which would be 28 + 24 = 52h. Actually, let's do that. Chose -12 bc it's evident that one group (SD 3.5) only had their stuff on 16h prior.

```{r}

analysis_data_full <- merged_data |> 
  filter(OneLoad == 1)|>
  filter(hoursfrom >= -12 & hoursfrom <= 38) %>% 
  group_by(Cow, hoursfrom) |>
  summarize(
    lyingm = as.numeric(sum(`Lying Time`/60, na.rm = TRUE)), 
    standingm = as.numeric(sum(`Standing Time`/60, na.rm = TRUE)), 
    steps = sum(`Steps`, na.rm = TRUE), 
    mi = sum(`Motion Index`, na.rm = TRUE), 
    transitions = sum(`Transitions`, na.rm = TRUE), 
    across(everything(), \(x) first(x)), 
    .groups = "drop")

#this helps remove data that is questionable without taking ALL the data. Removes calves who are lying with steps (unlikely) and who are standing with no steps (also unlikely) and all the calves who had their sensor removed at arrival which is all 3.5 calves except for 259, 248, 215). 
analysis_data_full_f <- analysis_data_full %>% 
  filter(!(lyingm == 60 & steps > 0),
         !(standingm == 60 & steps <= 25), 
         !(TRT == "DF3.5" & hoursfrom >= 30 & 
      !(Cow %in% c(259, 248, 215))))

write.csv(x=analysis_data_full_f, file = "data/filteredfull.csv" )
#data set goes from 11872 to 9836, so a loss of 2036 observations


dfall <- analysis_data_full_f %>% 
   filter(hoursfrom >= 35 & hoursfrom <= 40) %>%
  filter(TRT == "DF3.5") %>% 
  filter(timecat == "post") %>% 
  group_by(Cow) %>% 
  summarize(
    lay = sum(lyingm), 
    lay1 = sum(lyingm)/6)

dfall

write.csv(x=dfall, file = "data/offenders.csv" )


```

#### Laying

```{r}

analysis_data_full_f$hoursfrom_fact <- 
  factor(analysis_data_full_f$hoursfrom, 
         levels = sort(unique(analysis_data_full_f$hoursfrom)))


analysis_data_full_f$hours_num <- 
  as.numeric(as.character(analysis_data_full_f$hoursfrom))

#levels(analysis_data_full_f$hoursfrom_fact)


mod_base <- lme(
  fixed = lyingm ~ hoursfrom_fact * TRT,
  random = ~ 1 | Cow,
  data = analysis_data_full_f)

mod_ar1 <- lme(
  fixed = lyingm ~ hoursfrom_fact * TRT,
  random = ~ 1 | Cow,
  correlation = corAR1(form = ~ hours_num | Cow),
  data = analysis_data_full_f)

mod_rs <- lme(
  fixed = lyingm ~ hoursfrom_fact * TRT,
  random = ~ hours_num | Cow,
  data = analysis_data_full_f)


plot (mod_base)
plot(mod_ar1)
plot(mod_rs)

anova(mod_base, mod_ar1, mod_rs)




#AR1 is best based on model fit. 

mod_ar1 <- lme(
  fixed = lyingm ~ hoursfrom_fact * TRT + diaload ,
  random = ~ 1 | Cow,
  correlation = corAR1(form = ~ hours_num | Cow),
  data = analysis_data_full_f)

summary(mod_ar1)
car::Anova(mod_ar1, type=3)
emmeans(mod_ar1, ~ hoursfrom_fact|TRT)
emm<-emmeans(mod_ar1, ~ hoursfrom_fact|TRT)

emm_df <- as.data.frame(emm)
unique(emm_df$TRT)


custom_colors <- c("DF3.0" = "red4", "DF3.5" = "goldenrod2", "DF4.5" = "wheat4")
intercept_0 <- which(levels(emm_df$hoursfrom_fact) == "0")
intercept_26<- which(levels(emm_df$hoursfrom_fact) == "26")

ggplot(emm_df, aes(x = hoursfrom_fact, y = emmean, color = TRT, group = TRT)) +
   geom_vline(xintercept = c(intercept_0, intercept_26), linetype = "dashed", color = "gray11")+
  geom_line() +
  geom_point() +
  scale_color_manual(values=custom_colors)+
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width = 0.3) +
  labs(
    x = "Hour from Transport (0)",
    y = "Estimated Marginal Means of Lying Time") +
  theme_classic() +
  scale_y_continuous(limits = c(0, 61), breaks = seq(0, 61, by = 10))+
  scale_x_discrete(breaks = seq(-16, 40, by = 4)) +
      theme (legend.position = "top", 
         legend.direction = "horizontal", 
              axis.text = element_text(color = "black", size=10), 
               legend.text = element_text(color = "black", size=10))+
                theme(text=element_text(size=10, family = "Times New Roman"))



#Analysis by cattime? 


lm_lay <-lmer(lyingm ~TRT*timecat + diaload + BRTHW + (1|Cow), data=analysis_data_full_f)
summary(lm_lay)
emmeans(lm_lay, ~TRT|timecat)
anova(lm_lay, type = 3)
plot(lm_lay)


emm_lay <- emmeans(lm_lay, ~ TRT | timecat)
contrast_results <- pairs(emm_lay, reverse = FALSE)
summary(contrast_results, adjust = "tukey")



```

#### Standing

```{r}

analysis_data_full_f$hoursfrom_fact <- 
  factor(analysis_data_full_f$hoursfrom, 
         levels = sort(unique(analysis_data_full_f$hoursfrom)))


analysis_data_full_f$hours_num <- 
  as.numeric(as.character(analysis_data_full_f$hoursfrom))


mod_base <- lme(
  fixed = standingm ~ hoursfrom_fact * TRT,
  random = ~ 1 | Cow,
  data = analysis_data_full_f)

mod_ar1 <- lme(
  fixed = standingm ~ hoursfrom_fact * TRT,
  random = ~ 1 | Cow,
  correlation = corAR1(form = ~ hours_num | Cow),
  data = analysis_data_full_f)

mod_rs <- lme(
  fixed = standingm ~ hoursfrom_fact * TRT,
  random = ~ hours_num | Cow,
  data = analysis_data_full_f)


plot (mod_base)
plot(mod_ar1)
plot(mod_rs)

anova(mod_base, mod_ar1, mod_rs)




#AR1 is best based on model fit. 

mod_ar1 <- lme(
  fixed = standingm ~ hoursfrom_fact * TRT + diaload ,
  random = ~ 1 | Cow,
  correlation = corAR1(form = ~ hours_num | Cow),
  data = analysis_data_full_f)

summary(mod_ar1)
car::Anova(mod_ar1, type=3)
emmeans(mod_ar1, ~ hoursfrom_fact|TRT)
emm<-emmeans(mod_ar1, ~ hoursfrom_fact|TRT)

emm_df <- as.data.frame(emm)
unique(emm_df$TRT)

custom_colors <- c("DF3.0" = "red4", "DF3.5" = "goldenrod2", "DF4.5" = "wheat4")
intercept_0 <- which(levels(emm_df$hoursfrom_fact) == "0")
intercept_25 <- which(levels(emm_df$hoursfrom_fact) == "25")

ggplot(emm_df, aes(x = hoursfrom_fact, y = emmean, color = TRT, group = TRT)) +
  geom_vline(xintercept = c(intercept_0, intercept_25), linetype = "dashed", color = "gray11")+
  geom_line() +
  geom_point() +
  scale_color_manual(values=custom_colors)+
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width = 0.3) +
  labs(
    x = "Hour from Transport (0)",
    y = "Estimated Marginal Means of Standing Time") +
  theme_classic() +
  scale_y_continuous(limits = c(0, 60), breaks = seq(0, 60, by = 10))+
  scale_x_discrete(breaks = seq(-16, 40, by = 4)) +
      theme (legend.position = "top", 
         legend.direction = "horizontal", 
              axis.text = element_text(color = "black", size=10), 
               legend.text = element_text(color = "black", size=10))+
                theme(text=element_text(size=10, family = "Times New Roman"))



#Analysis by cattime? 


lm_stand <-lmer(standingm ~TRT*timecat + diaload + BRTHW + (1|Cow), data=analysis_data_full_f)
summary(lm_stand)
emmeans(lm_stand, ~TRT|timecat)
plot(lm_stand)


emm_lay <- emmeans(lm_stand, ~ TRT | timecat)
contrast_results <- pairs(emm_lay, reverse = FALSE)
summary(contrast_results, adjust = "tukey")
```

#### Steps

```{r}

analysis_data_full_f$hoursfrom_fact <- 
  factor(analysis_data_full_f$hoursfrom, 
         levels = sort(unique(analysis_data_full_f$hoursfrom)))


analysis_data_full_f$hours_num <- 
  as.numeric(as.character(analysis_data_full_f$hoursfrom))

mod_base <- lme(
  fixed = steps ~ hoursfrom_fact * TRT,
  random = ~ 1 | Cow,
  data = analysis_data_full_f)

mod_ar1 <- lme(
  fixed = steps ~ hoursfrom_fact * TRT,
  random = ~ 1 | Cow,
  correlation = corAR1(form = ~ hours_num | Cow),
  data = analysis_data_full_f)

#mod_rs <- lme(
# fixed = steps ~ hoursfrom_fact * TRT,
#  random = ~ hours_num | Cow,
#  data = analysis_data_full)


plot (mod_base)
plot(mod_ar1)
#plot(mod_rs)

anova(mod_base, mod_ar1)




#AR1 is best based on model fit. 

mod_ar1 <- lme(
  fixed = steps ~ hoursfrom_fact * TRT + diaload ,
  random = ~ 1 | Cow,
  correlation = corAR1(form = ~ hours_num | Cow),
  data = analysis_data_full_f)

summary(mod_ar1)
car::Anova(mod_ar1, type=3)
emmeans(mod_ar1, ~ hoursfrom_fact|TRT)
emm<-emmeans(mod_ar1, ~ hoursfrom_fact|TRT)

emm_df <- as.data.frame(emm)
unique(emm_df$TRT)

custom_colors <- c("DF3.0" = "red4", "DF3.5" = "goldenrod2", "DF4.5" = "wheat4")
ggplot(emm_df, aes(x = hoursfrom_fact, y = emmean, color = TRT, group = TRT)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values=custom_colors)+
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width = 0.3) +
  labs(
    x = "Hour from Transport (0)",
    y = "Estimated Marginal Means of Steps") +
  theme_classic() +
  scale_y_continuous(limits = c(0, 200), breaks = seq(0, 200, by = 50))+
  scale_x_discrete(breaks = seq(-16, 40, by = 4)) +
      theme (legend.position = "none", 
         legend.direction = "horizontal", 
              axis.text = element_text(color = "black", size=10), 
               legend.text = element_text(color = "black", size=10))+
                theme(text=element_text(size=10, family = "Times New Roman"))



#Analysis by cattime? 


lm_lay <-lmer(steps ~TRT*timecat + diaload + BRTHW + (1|Cow), data=analysis_data_full_f)
summary(lm_lay)
emmeans(lm_lay, ~TRT|timecat)
plot(lm_lay)


emm_lay <- emmeans(lm_lay, ~ TRT | timecat)
contrast_results <- pairs(emm_lay, reverse = FALSE)
summary(contrast_results, adjust = "tukey")
```

#### Motion Index

```{r}
analysis_data_full_f$hoursfrom_fact <- 
  factor(analysis_data_full_f$hoursfrom, 
         levels = sort(unique(analysis_data_full_f$hoursfrom)))


analysis_data_full_f$hours_num <- 
  as.numeric(as.character(analysis_data_full_f$hoursfrom))

mod_base <- lme(
  fixed = mi ~ hoursfrom_fact * TRT,
  random = ~ 1 | Cow,
  data = analysis_data_full_f)

mod_ar1 <- lme(
  fixed = mi ~ hoursfrom_fact * TRT,
  random = ~ 1 | Cow,
  correlation = corAR1(form = ~ hours_num | Cow),
  data = analysis_data_full_f)

#mod_rs <- lme(
# fixed = mi ~ hoursfrom_fact * TRT,
#  random = ~ hours_num | Cow,
#  data = analysis_data_full)


plot (mod_base)
plot(mod_ar1)
#plot(mod_rs)

anova(mod_base, mod_ar1)




#AR1 is best based on model fit. 

mod_ar1 <- lme(
  fixed = mi ~ hoursfrom_fact * TRT + diaload ,
  random = ~ 1 | Cow,
  correlation = corAR1(form = ~ hours_num | Cow),
  data = analysis_data_full_f)

summary(mod_ar1)
car::Anova(mod_ar1, type=3)
emmeans(mod_ar1, ~ hoursfrom_fact|TRT)
emm<-emmeans(mod_ar1, ~ hoursfrom_fact|TRT)

emm_df <- as.data.frame(emm)
unique(emm_df$TRT)

custom_colors <- c("DF3.0" = "red4", "DF3.5" = "goldenrod2", "DF4.5" = "wheat4")
ggplot(emm_df, aes(x = hoursfrom_fact, y = emmean, color = TRT, group = TRT)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values=custom_colors)+
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width = 0.3) +
  labs(
    x = "Hour from Transport (0)",
    y = "Estimated Marginal Means MI") +
  theme_classic() +
  scale_y_continuous(limits = c(0, 1000), breaks = seq(0, 1000, by = 100))+
  scale_x_discrete(breaks = seq(-16, 40, by = 4)) +
      theme (legend.position = "none", 
         legend.direction = "horizontal", 
              axis.text = element_text(color = "black", size=10), 
               legend.text = element_text(color = "black", size=10))+
                theme(text=element_text(size=10, family = "Times New Roman"))



#Analysis by cattime? 


lm_lay <-lmer(mi ~TRT*timecat + diaload + BRTHW + (1|Cow), data=analysis_data_full_f)
summary(lm_lay)
emmeans(lm_lay, ~TRT|timecat)
plot(lm_lay)


emm_lay <- emmeans(lm_lay, ~ TRT | timecat)
contrast_results <- pairs(emm_lay, reverse = FALSE)
summary(contrast_results, adjust = "tukey")
```

#### Transitions

```{r}
analysis_data_full_f$hoursfrom_fact <- 
  factor(analysis_data_full_f$hoursfrom, 
         levels = sort(unique(analysis_data_full_f$hoursfrom)))


analysis_data_full_f$hours_num <- 
  as.numeric(as.character(analysis_data_full_f$hoursfrom))


mod_base <- lme(
  fixed = transitions ~ hoursfrom_fact * TRT,
  random = ~ 1 | Cow,
  data = analysis_data_full_f)

mod_ar1 <- lme(
  fixed = transitions ~ hoursfrom_fact * TRT,
  random = ~ 1 | Cow,
  correlation = corAR1(form = ~ hours_num | Cow),
  data = analysis_data_full_f)

#mod_rs <- lme(
# fixed = steps ~ hoursfrom_fact * TRT,
#  random = ~ hours_num | Cow,
#  data = analysis_data_full)


plot (mod_base)
plot(mod_ar1)
#plot(mod_rs)

anova(mod_base, mod_ar1)




#AR1 is best based on model fit. 

mod_ar1 <- lme(
  fixed = transitions ~ hoursfrom_fact * TRT + diaload ,
  random = ~ 1 | Cow,
  correlation = corAR1(form = ~ hours_num | Cow),
  data = analysis_data_full_f)

summary(mod_ar1)
car::Anova(mod_ar1, type=3)
emmeans(mod_ar1, ~ hoursfrom_fact|TRT)
emm<-emmeans(mod_ar1, ~ hoursfrom_fact|TRT)

emm_df <- as.data.frame(emm)
unique(emm_df$TRT)

custom_colors <- c("DF3.0" = "red4", "DF3.5" = "goldenrod2", "DF4.5" = "wheat4")
ggplot(emm_df, aes(x = hoursfrom_fact, y = emmean, color = TRT, group = TRT)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values=custom_colors)+
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width = 0.3) +
  labs(
    x = "Hour from Transport (0)",
    y = "Estimated Marginal Means of Transitions") +
  theme_classic() +
  scale_y_continuous(limits = c(0, 10), breaks = seq(0, 10, by = 5))+
  scale_x_discrete(breaks = seq(-16, 40, by = 4)) +
      theme (legend.position = "none", 
         legend.direction = "horizontal", 
              axis.text = element_text(color = "black", size=10), 
               legend.text = element_text(color = "black", size=10))+
                theme(text=element_text(size=10, family = "Times New Roman"))



#Analysis by cattime? 


lm_lay <-lmer(transitions ~TRT*timecat + diaload + BRTHW + (1|Cow), data=analysis_data_full_f)
summary(lm_lay)
emmeans(lm_lay, ~TRT|timecat)
plot(lm_lay)


emm_lay <- emmeans(lm_lay, ~ TRT | timecat)
contrast_results <- pairs(emm_lay, reverse = FALSE)
summary(contrast_results, adjust = "tukey")
```
