---
title: "ALL CALVES"
author: "WAK"
format: html
editor: visual
---

```{r}
#| include: false
#| warning: false
#| echo: false

library(epiDisplay)
library(knitr)
library(pROC)
library(tidyverse)
library(readxl)
library(ggplot2)
library(gmodels)
library(ggbeeswarm)
library(dplyr)
library(readr)
library(ggpubr)
library(psych)
library(lme4)
library(Matrix)
library(lmerTest)
library(irr)
library(lmerTest)
library(emmeans)
library(doBy)       
library(gmodels)    
library(car)           
library(cowplot)       
library(gridGraphics)  
library(multcomp)
library(hms)
library(gt)
library(lubridate)
library(nlme)
library(extrafont)
library(stringi)
```

### Data Steps

#### Pull in data

```{r}
#| include: false
#| warning: false
#| echo: false

all <- read_csv('data/all enroll MOC.csv')

all %>%
  group_by(ID) %>%
  summarize(n = n()) %>%
  filter(n > 1)

stack <- read_csv('data/clean.csv')


full <- all %>% 
  left_join(stack, by = "ID")

write.csv(x = full, file = "data/full.csv")


```

#### Creating new variables

```{r}
#| warning: false
#| echo: false

#first select which variables remain in the data set: 

full_new <- 
  full %>% 
  select( ID, EID.x, BIRTH, sex, BREED,Breed2, BRTHW, SERUM, SORCE, TRL2, LOADT, Date_PNEU1, Remark_PNEU1, Date_PNEU2, Remark_PNEU2, Date_PNEU3, Remark_PNEU3, Date_SCOURS1, Remark_SCOURS1, Date_SCOURS2, Remark_SCOURS2, Date_BLOAT1, Remark_BLOAT1, Date_BLOAT2, Remark_BLOAT2, Date_DIED1, Remark_DIED1)

full_new$TRL2 = as.character(full_new$TRL2)


#convert all dates into date vs. chr variables

head(full_new$BIRTH)
head(full_new$LOADT)


#create a new variable called ARR wich is LOADT + 1
full_new <- full_new %>%
  mutate(
    LOADT_date = mdy(LOADT),          
    ARR = LOADT_date + days(1)
  )

#convert dates so can add and subtract

full_new <- full_new %>%
  mutate(
    BIRTH = mdy(BIRTH),
    LOADT = mdy(LOADT))

#create some new variables realted to days in age at stuff and age from arrival at stuff. 

#days in age load
#days in age arrival
#dfa pneu1
#dfa pneu2
#dfa pneu3
#dfa scour1
#dfa scour 2
#dfa bloat1
#dfa bloat2
#dfa died

full_new<- 
  full_new %>% 
  mutate(
    diaload = as.numeric(LOADT - BIRTH), 
    diaARR = as.numeric (ARR - BIRTH), 
    dfaP1 = as.numeric(Date_PNEU1 - ARR),
    dbtwP12 = as.numeric(Date_PNEU2-Date_PNEU1),
    dbtwP23 = as.numeric(Date_PNEU3-Date_PNEU2),
    dfaP2 = as.numeric(Date_PNEU2 - ARR), 
    dfaP3 = as.numeric(Date_PNEU3 - ARR), 
    dfaD1 = as.numeric(Date_SCOURS1 - ARR),
    dfaD2 = as.numeric(Date_SCOURS2 - ARR), 
    dbtwD12 = as.numeric(Date_SCOURS2 - Date_SCOURS1),
    dfaB1 = as.numeric(Date_BLOAT1 - ARR), 
    dfaB2 = as.numeric(Date_BLOAT2 - ARR), 
    dfaDIED = as.numeric(Date_DIED1 - ARR))

#create unique identifier for trailer load using date and trl2 

full_new <- full_new %>%
  mutate(
    LOAD = factor(paste(LOADT, TRL2, Breed2, sep = "_")))

datachecks <- full_new %>% 
  count(LOAD)

datachecks

write.csv(x = datachecks, file = "data/trailer loads.csv")

#n=4 calves that died/euthanized at MOC before they left but were still enrolled. Removed them from data sheet; also removed 1 animal that was loaded out on 8.11 for unknown reasons (the only animal that day)

#need to check with Brett on the trailer load data, looks like there are ~16ish loads for each SD, which is btw 2000-3000 calves per group.


#add some new variables like pn1yn etc for all treatments but need to use days between for PN1/2/3

full_new<- full_new %>% 
  mutate(
   PN1a = if_else(dfaP1>=0, 1, 0) %>% replace_na(0), 
   PN2 = if_else(dfaP2>=0, 1, 0)%>% replace_na(0),
   PN3 = if_else(dfaP3>=0, 1, 0) %>% replace_na(0), 
   DIA1 = ifelse(dfaD1>=0, 1, 0)%>% replace_na(0), 
   DIA2 = ifelse(dfaD2>=0, 1, 0)%>% replace_na(0), 
   B1 = ifelse(dfaB1>=0, 1, 0)%>% replace_na(0), 
   B2 = ifelse(dfaB2>=0, 1, 0)%>% replace_na(0), 
   DIED = ifelse(dfaDIED>=0, 1, 0)%>% replace_na(0))

#add some new variables like pn1yn etc for all treatments but need to use days between for PN1/2/3
##WORKING ON THIS NEED TO MAKE IT AND/OR statement I think? 
#new resp event if >7d from previous treatment

#the n doesn't change of total treatment events if use 7 or 5d. Wonder what happens if use 14d? 


FINAL7_new<- full_new %>% 
  mutate(
    PN2a = case_when(
      PN2 == 1 & dbtwP12 >= 7 | PN3 == 1 & dbtwP23 >= 7    ~ 1, 
      PN2 == 1 & dbtwP12 <  7 | PN2 == 0  | PN3 == 1 & dbtwP23 < 7 ~ 0))


FINAL7_new<- FINAL7_new %>% 
  mutate(
    Date_PN1a = Date_PNEU1)

FINAL7_new <- FINAL7_new %>% 
  mutate(
    Date_PN2a = case_when(
      PN2a == 1 & dbtwP12 <7 ~ FINAL7_new$Date_PNEU3, 
      PN2a == 1 & dbtwP12 >= 7 ~ FINAL7_new$Date_PNEU2))



FINAL14_new<- full_new %>% 
  mutate(
    PN2a = case_when(
      PN2 == 1 & dbtwP12 >= 14 | PN3 == 1 & dbtwP23 >= 14    ~ 1, 
      PN2 == 1 & dbtwP12 <  14 | PN2 == 0  | PN3 == 1 & dbtwP23 < 14 ~ 0))



FINAL14_new<- FINAL14_new %>% 
  mutate(
    Date_PN1a = Date_PNEU1)

FINAL14_new <- FINAL14_new %>% 
  mutate(
    Date_PN2a = case_when(
      PN2a == 1 & dbtwP12 <14 ~ FINAL14_new$Date_PNEU3, 
      PN2a == 1 & dbtwP12 >= 14 ~ FINAL14_new$Date_PNEU2))


FINAL7_new %>% 
  summarize(
    sum(PN1a), 
    sum(PN2a), 
    sum(DIA1))

FINAL14_new %>% 
  summarize(
    sum(PN1a), 
    sum(PN2a))

FINAL7_new %>% 
  group_by(Remark_PNEU1) %>% 
  count()

FINAL7_new %>% 
  group_by(Remark_PNEU2) %>% 
  count()


write.csv(x = FINAL7_new, file = "data/PNchecks.csv")

#PN1 and PN2 are now correct! Yay!
   


#SCOURS
#now need to figure out the calves who had scours treatment prior to shipment (what were they treated with?) and likely need to exlcude them (n=944 total calves; 4% of data)


FINAL7_new %>% 
  filter(dfaD1<0) %>% 
  group_by(Remark_SCOURS1) %>% 
  count()

FINAL7_new %>% 
  filter(dfaD1<0) %>% 
  group_by(Remark_SCOURS2) %>% 
  count()

  
```

### Summaries with Calf Key

This description is for all calves with a TRL2 item (n=21255)

```{r}
#| warning: false
#| echo: false

full|> 
  group_by(TRL2) |> 
  summarize (Count = n())

full |> 
  group_by(TRL2, sex) |> 
  summarize (Count = n())

full |> 
  group_by(TRL2, sex, BREED) |> 
  summarize (Count = n())

full |> 
  group_by(TRL2, BREED) |> 
  summarize (Count = n())

full |> 
  group_by(TRL2) |> 
  summarize (
    stp = mean(BRTHW))

full |> 
  group_by(TRL2, BREED) |> 
  summarize (
    stp = mean(BRTHW))


FINAL_new %>% 
  group_by(TRL2) %>% 
  summarize(
    prop_P1 = mean(PN1a, na.rm=TRUE),
    avg_PI = mean(dfaP1, na.rm=TRUE),
    btwP12 = mean(dbtwP12, na.rm=TRUE),
    prop_P2 = mean(PN2a, na.rm=TRUE),
    avg_P2 = mean(dfaP2, na.rm=TRUE), 
    btwP23 = mean(dbtwP23, na.rm=TRUE),
    prop_DIA = mean(DIA1), 
    avg_DIA = mean(dfaD1, na.rm=TRUE), 
    btwD12 = mean(dbtwD12, na.rm=TRUE),
    prop_B = mean(B1), 
    avg_B = mean(dfaB1, na.rm=TRUE), 
    prop_DED = mean(DIED), 
    avg_DED = mean(dfaDIED, na.rm=TRUE))


```
