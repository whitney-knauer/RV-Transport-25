---
title: "ALL CALVES"
author: "WAK"
format: html
editor: visual
---

```{r}
#| include: false
#| warning: false
#| echo: false

library(epiDisplay)
library(knitr)
library(pROC)
library(tidyverse)
library(readxl)
library(ggplot2)
library(gmodels)
library(ggbeeswarm)
library(dplyr)
library(readr)
library(ggpubr)
library(psych)
library(lme4)
library(Matrix)
library(lmerTest)
library(irr)
library(lmerTest)
library(emmeans)
library(doBy)       
library(gmodels)    
library(car)           
library(cowplot)       
library(gridGraphics)  
library(multcomp)
library(hms)
library(gt)
library(lubridate)
library(nlme)
library(extrafont)
library(stringi)
library(survival)
library(survminer)
library(patchwork)
library(coxme)
library(marginaleffects)
```

### Data Steps

#### Pull in data

```{r}
#| include: false
#| warning: false
#| echo: false

all <- read_csv('data/all enroll MOC.csv')
tcc <- read_csv('data/TCC time in transit.csv')
dvc <- read_csv('data/DVC time in transit.csv')

both <- 
  bind_rows(
    tcc = tcc, 
    dvc = dvc, 
    .id = "source"
  )

all %>%
  group_by(ID) %>%
  summarize(n = n()) %>%
  filter(n > 1)

time <- all %>% 
  left_join(both, by = "ID")


stack <- read_csv('data/clean.csv')


full <- time %>% 
  left_join(stack, by = "ID")

write.csv(x = full, file = "data/full.csv")


```

#### Creating new variables

```{r}
#| warning: false
#| echo: false

#first select which variables remain in the data set: 

full_new <- 
  full %>% 
  select( ID, EID.x, BIRTH, sex, BREED,Breed2, TRVHR, time, BRTHW, SERUM, SORCE, TRL2.x, LOADT, Date_PNEU1, Remark_PNEU1, Date_PNEU2, Remark_PNEU2, Date_PNEU3, Remark_PNEU3, Date_SCOURS1, Remark_SCOURS1, Date_SCOURS2, Remark_SCOURS2, Date_BLOAT1, Remark_BLOAT1, Date_BLOAT2, Remark_BLOAT2, Date_NAVEL1, Remark_NAVEL1, Date_NAVEL2, Remark_NAVEL2, Date_NAVEL3, Remark_NAVEL3, Date_DIED1, Remark_DIED1)

full_new$TRL2 = as.character(full_new$TRL2.x)


#convert all dates into date vs. chr variables

head(full_new$BIRTH)
head(full_new$LOADT)


#create a new variable called ARR wich is LOADT + 1
full_new <- full_new %>%
  mutate(
    LOADT_date = mdy(LOADT),          
    ARR = LOADT_date + days(1))

#convert dates so can add and subtract

full_new <- full_new %>%
  mutate(
    BIRTH = mdy(BIRTH),
    LOADT = mdy(LOADT))

#create some new variables realted to days in age at stuff and age from arrival at stuff. 

#days in age load
#days in age arrival
#dfa pneu1
#dfa pneu2
#dfa pneu3
#dfa scour1
#dfa scour 2
#dfa bloat1
#dfa bloat2
#dfa died

full_new<- 
  full_new %>% 
  mutate(
    diaload = as.numeric(LOADT - BIRTH), 
    diaARR = as.numeric (ARR - BIRTH), 
    dfaP1 = as.numeric(Date_PNEU1 - ARR),
    dbtwP12 = as.numeric(Date_PNEU2-Date_PNEU1),
    dbtwP23 = as.numeric(Date_PNEU3-Date_PNEU2),
    dfaP2 = as.numeric(Date_PNEU2 - ARR), 
    dfaP3 = as.numeric(Date_PNEU3 - ARR), 
    dfaD1 = as.numeric(Date_SCOURS1 - ARR),
    dfaD2 = as.numeric(Date_SCOURS2 - ARR), 
    dbtwD12 = as.numeric(Date_SCOURS2 - Date_SCOURS1),
    dfaB1 = as.numeric(Date_BLOAT1 - ARR), 
    dfaB2 = as.numeric(Date_BLOAT2 - ARR), 
    dfaN1 = as.numeric(Date_NAVEL1 - ARR), 
    dfaN2 = as.numeric(Date_NAVEL2 - ARR),
    dfaN3 = as.numeric(Date_NAVEL3 - ARR),
    dfaDIED = as.numeric(Date_DIED1 - ARR))

#create unique identifier for trailer load using date and trl2 

full_new <- full_new %>%
  mutate(
    LOAD = factor(paste(LOADT, TRL2, Breed2, sep = "_")))

datachecks <- full_new %>% 
  count(LOAD)

datachecks

write.csv(x = datachecks, file = "data/trailer loads.csv")

#n=4 calves that died/euthanized at MOC before they left but were still enrolled. Removed them from data sheet; also removed 1 animal that was loaded out on 8.11 for unknown reasons (the only animal that day)

#need to check with Brett on the trailer load data, looks like there are ~16ish loads for each SD, which is btw 2000-3000 calves per group.

#got the trailer loads figured out! Now need to pull in the data to merge on LOAD so can remove data that don't need (~10,000 calves)

load <- read_csv('data/Trailer Load FINAL.csv')

load %>% 
  summarize(
    sum = sum(n))



full_new1 <-  full_new %>% 
  inner_join(load, by = "LOAD")


#need to make sure data is correct for time in transit. If a calf has an NA for time then that variable needs to be TRVhr. 

full_new1 <- full_new1 %>% 
  mutate(
    transitT = case_when( time > 0     ~ time, 
                          is.na(time)  ~ TRVhr))


```

#### Messing around with Pneu/Scour

```{r}
#| warning: false
#| echo: false

#add some new variables like pn1yn etc for all treatments but need to use days between for PN1/2/3

full_new1<- full_new1 %>% 
  mutate(
   PN1a = if_else(dfaP1>=0, 1, 0) %>% replace_na(0), 
   PN2 = if_else(dfaP2>=0, 1, 0)%>% replace_na(0),
   PN3 = if_else(dfaP3>=0, 1, 0) %>% replace_na(0), 
   DIA1 = ifelse(dfaD1>=0, 1, 0)%>% replace_na(0), 
   DIA2 = ifelse(dfaD2>=0, 1, 0)%>% replace_na(0), 
   B1 = ifelse(dfaB1>=0, 1, 0)%>% replace_na(0), 
   B2 = ifelse(dfaB2>=0, 1, 0)%>% replace_na(0), 
   N1 = ifelse(dfaN1>=0, 1, 0) %>% replace_na(0),
   DIED = ifelse(dfaDIED>=0, 1, 0)%>% replace_na(0))

#add some new variables like pn1yn etc for all treatments but need to use days between for PN1/2/3
##WORKING ON THIS NEED TO MAKE IT AND/OR statement I think? 
#new resp event if >7d from previous treatment

#the n doesn't change of total treatment events if use 7 or 5d. Wonder what happens if use 14d? 


FINAL7_new<- full_new1 %>% 
  mutate(
    PN2a = case_when(
      PN2 == 1 & dbtwP12 >= 7 | PN3 == 1 & dbtwP23 >= 7    ~ 1, 
      PN2 == 1 & dbtwP12 <  7 | PN2 == 0  | PN3 == 1 & dbtwP23 < 7 ~ 0))


FINAL7_new<- FINAL7_new %>% 
  mutate(
    Date_PN1a = Date_PNEU1)

FINAL7_new <- FINAL7_new %>% 
  mutate(
    Date_PN2a = case_when(
      PN2a == 1 & dbtwP12 <7 ~ FINAL7_new$Date_PNEU3, 
      PN2a == 1 & dbtwP12 >= 7 ~ FINAL7_new$Date_PNEU2))



FINAL14_new<- full_new1 %>% 
  mutate(
    PN2a = case_when(
      PN2 == 1 & dbtwP12 >= 14 | PN3 == 1 & dbtwP23 >= 14    ~ 1, 
      PN2 == 1 & dbtwP12 <  14 | PN2 == 0  | PN3 == 1 & dbtwP23 < 14 ~ 0))



FINAL14_new<- FINAL14_new %>% 
  mutate(
    Date_PN1a = Date_PNEU1)

FINAL14_new <- FINAL14_new %>% 
  mutate(
    Date_PN2a = case_when(
      PN2a == 1 & dbtwP12 <14 ~ FINAL14_new$Date_PNEU3, 
      PN2a == 1 & dbtwP12 >= 14 ~ FINAL14_new$Date_PNEU2))


FINAL7_new %>% 
  summarize(
    sum(PN1a), 
    sum(PN2a), 
    sum(DIA1))

FINAL14_new %>% 
  summarize(
    sum(PN1a), 
    sum(PN2a))

FINAL7_new %>% 
  group_by(Remark_PNEU1) %>% 
  count()

FINAL7_new %>% 
  group_by(Remark_PNEU2) %>% 
  count()


write.csv(x = FINAL7_new, file = "data/PNchecks.csv")

#PN1 and PN2 are now correct! Yay!
   


#SCOURS
#now need to figure out the calves who had scours treatment prior to shipment (what were they treated with?) and likely need to exlcude them (n=420 total calves; 4% of data) and control for them when evaluating PN?


FINAL7_new %>% 
  filter(dfaD1<0) %>% 
 # group_by(Remark_SCOURS1) %>% 
  count()

FINAL7_new %>% 
  filter(dfaD1<0) %>% 
  group_by(SD) %>% 
  count()

FINAL7_new %>% 
  group_by(SD) %>% 
  count()


#make new dfaPN1a and dfaPN2a

FINAL7_new<- 
  FINAL7_new %>% 
  mutate(
    dfaPN1a = as.numeric(Date_PN1a - ARR), 
    dfaPN2a = as.numeric (Date_PN2a - ARR))

#new variable to say if calves were treated prior to departure for DIA (4% of calves, same in all groups)

FINAL7_new <- FINAL7_new %>% 
  mutate(
    diaex = 
      case_when(is.na(dfaD1) ~ 0,
                dfaD1<0 ~  1, 
                dfaD1>= 0 ~ 0))

FINAL7_new %>% 
  summarize(
    sum = sum(diaex, na.rm=TRUE))

#serum total protein, messing with

FINAL7_new <-FINAL7_new %>% 
  mutate(
    stp = SERUM/10)


#NAVEL - looks like calves get three treatments if they get treated? 
#who had navel treatment prior to shipment (what were they treated with?) and likely need to exlcude them?
#also n=400 calves. Yikes. Only 38 treated on or after arrival.  

FINAL7_new %>% 
  filter(dfaN1>=0) %>% 
 group_by(Remark_NAVEL1) %>% 
  count()

FINAL7_new %>% 
  filter(dfaN1>=0) %>% 
  group_by(SD) %>% 
  count()


FINAL7_new %>% 
  filter(dfaN1>=0) %>% 
  summarize(
    mean = mean(dfaN1), 
    sd = sd (dfaN1))



FINAL7_new %>% 
  group_by(SD) %>% 
  count()

#make a navelex group to exclude calves traeted for navel prior to leaving. 

FINAL7_new <- FINAL7_new %>% 
  mutate(
    navelex = 
      case_when(is.na(dfaN1) ~ 0,
                dfaN1 < 0 ~  1, 
                dfaN1 >= 0 ~ 0))


FINAL7_new %>% 
  filter(navelex==1) %>% 
  count()
```

### Descriptive Analysis

#### General Description

This description is for all calves with a TRL2 item (n=10324)

```{r}
#| warning: false
#| echo: false



FINAL7_new %>% 
  group_by(SD) %>% 
  summarize (Count = n())

FINAL7_new |> 
  group_by(SD, Sex) |> 
  summarize (Count = n())

FINAL7_new |> 
  group_by(sbTRT) |> 
  summarize (Count = n())

FINAL7_new %>% 
  group_by(SORCE) %>% 
  summarize (Count = n())


FINAL7_new |> 
  group_by(SD) |> 
  summarize (
    bwt = mean(BRTHW), 
    bwtsd = sd(BRTHW),
    arrage = mean(diaARR), 
    arrA   = sd (diaARR), 
    loadage = mean(diaload), 
    sdload  = sd (diaload), 
    tranit  = mean(transitT), 
    transd  = sd(transitT))

FINAL7_new |>
  filter(stp > 0) |>
  group_by(SD) |>
  summarize(
    count = n(),
    mean_stp = mean(stp, na.rm = TRUE),
    sd_stp   = sd(stp, na.rm = TRUE),
    .groups = "drop")

FINAL7_new |> 
  filter(stp!=0) %>% 
  ggplot(mapping=aes(x=stp))+
  theme_classic()+
  geom_histogram(binwidth=0.2, 
                 fill="skyblue", 
                 color="black", 
                 alpha=0.7)+
  labs(title = "Histogram of stp")


FINAL7_new |> 
  ggplot(mapping=aes(x=transitT))+
  theme_classic()+
  geom_histogram(binwidth=0.2, 
                 fill="orange", 
                 color="black", 
                 alpha=0.7)+
  labs(title = "Histogram of transit time (h)")



FINAL7_new |> 
  group_by(SD, DB) |> 
  summarize (
    bwt = mean(BRTHW), 
    bwtsd = sd(BRTHW),
    arrage = mean(diaARR), 
    arrA   = sd (diaARR),
    loadage = mean(diaload), 
    sdload  = sd (diaload), 
    tranit  = mean(transitT), 
    transd  = sd(transitT))

FINAL7_new |>
  filter(stp > 0) |>
  group_by(SD, DB) |>
  summarize(
    count = n(),
    mean_stp = mean(stp, na.rm = TRUE),
    sd_stp   = sd(stp, na.rm = TRUE),
    .groups = "drop")


FINAL7_new %>% 
  group_by(SD) %>% 
  summarize(
    prop_P1 = mean(PN1a, na.rm=TRUE),
    prop_P2 = mean(PN2a, na.rm=TRUE),
    meandfaP1 = mean(dfaPN1a, na.rm = TRUE), 
    meandfaP2 = mean(dfaPN2a, na.rm = TRUE),
    prop_DED = mean(DIED), 
    avg_DED = mean(dfaDIED, na.rm=TRUE))


FINAL7_new %>% 
  group_by(SD, DBxS) %>% 
  summarize(
    prop_P1 = mean(PN1a, na.rm=TRUE),
    prop_P2 = mean(PN2a, na.rm=TRUE),
    meandfaP1 = mean(dfaPN1a, na.rm = TRUE), 
    meandfaP2 = mean(dfaPN2a, na.rm = TRUE),
    prop_DED = mean(DIED), 
    avg_DED = mean(dfaDIED, na.rm=TRUE))


#Exclcuding those that scoured prior to shipping. 

FINAL7_new %>% 
  filter (diaex == 0) %>% 
  group_by(SD) %>% 
  summarize(
    prop_DIA = mean(DIA1, na.rm=TRUE), 
    meandfaD1 = mean(dfaD1, na.rm=TRUE))


FINAL7_new %>% 
  filter (diaex == 0) %>% 
  group_by(SD, DB) %>% 
  summarize(
    prop_DIA = mean(DIA1, na.rm=TRUE), 
    meandfaD1 = mean(dfaD1, na.rm=TRUE))


FINAL7_new %>% 
  filter (diaex == 1) %>% 
  group_by(SD) %>% 
  summarize(
    prop_DIA = mean(DIA1, na.rm=TRUE), 
    meandfaD1 = mean(dfaD1, na.rm=TRUE), 
     prop_P1 = mean(PN1a, na.rm=TRUE))


FINAL7_new %>% 
  filter (diaex == 1) %>% 
  group_by(SD, DB) %>% 
  summarize(
    prop_DIA = sum(diaex, na.rm=TRUE), 
    meandfaD1 = mean(dfaD1, na.rm=TRUE))



#Excluding navels prior to shipping

FINAL7_new %>% 
  filter (navelex == 0) %>% 
  group_by(SD) %>% 
  summarize(
  prop_N = mean(N1, na.rm=TRUE), 
    meandfaN1 = mean(dfaN1, na.rm=TRUE))


FINAL7_new %>% 
  filter (navelex == 0) %>% 
  group_by(SD, DB) %>% 
  summarize(
    prop_N = mean(N1, na.rm=TRUE), 
    meandfaN1 = mean(dfaN1, na.rm=TRUE))

FINAL7_new %>% 
  filter (navelex == 1) %>% 
  group_by(SD) %>% 
  summarize(
  prop_N = sum(N1, na.rm=TRUE), 
    meandfaN1 = mean(dfaN1, na.rm=TRUE))


FINAL7_new %>% 
  filter (navelex == 1) %>% 
  group_by(SD, DB) %>% 
  summarize(
    prop_N = sum(N1, na.rm=TRUE), 
    meandfaN1 = mean(dfaN1, na.rm=TRUE))


#Some simple stats on enrollment statistics. 





```

#### Load summaries

```{r}
#| warning: false
#| echo: false



load %>% 
  group_by(SD) %>% 
  summarize (Count = n(), 
             total = sum(n), 
             mean = mean(n),
             sd   = sd(n))

load %>% 
  group_by(SD, DBxS) %>% 
  summarize (Count = n(), 
             total = sum(n), 
             mean = mean(n),
             sd   = sd(n))

travel_time <- FINAL7_new %>% 
  group_by(LOAD) %>% 
  summarize (
    trvH = mean (TRVHR, na.rm = TRUE), 
    trvHsd = sd (TRVHR, na.rm = TRUE))

travel_time

write.csv(x=travel_time, file = "data/travel_time.csv")

#if there is missing data, the group will get the average for the SD for that metric. 
#missing were: 3.0SD_D_7.1; ALL from 7/8 - 3.5B, 3.5D, 4.5B; 
FINAL7_new %>% 
  group_by(TRL2) %>% 
  summarize (
    trvH = mean (TRVHR, na.rm = TRUE), 
    trvHsd = sd (TRVHR, na.rm = TRUE))


FINAL7_new %>% 
  group_by(TRL2, Breed2) %>% 
  summarize (
    trvH = mean (TRVHR, na.rm = TRUE), 
    trvHsd = sd (TRVHR, na.rm = TRUE))


```

#### Health Treatment to 60d

```{r}
#| warning: false
#| echo: false


#need to right censor data to 30 and 60d (?) and clean up the data set becasue there's too many variables. 


#create new variables DIA30; PNEU30, PNEU60 such that if the calf has a treatment and is less than the prescribed days, then the day is dfaPN1a but otherwise, it's 30 or 60 to allow sensoring. 


FINAL7_new <- FINAL7_new %>% 
  mutate(
    DIA30 = if_else(diaex == 0,
                    coalesce(dfaD1, 30),
                    NA_real_))

FINAL7_new <- FINAL7_new %>% 
  mutate(
    D30 = if_else(DIA30 < 30, 1L, 0L))


FINAL7_new <- FINAL7_new %>% 
  mutate(
    Nav30 = if_else(navelex == 0,
                    coalesce(dfaN1, 30),
                    NA_real_))

FINAL7_new <- FINAL7_new %>% 
  mutate(
    N30 = if_else(Nav30 < 30, 1L, 0L))

FINAL7_new <- FINAL7_new %>% 
  mutate(
    PNEU30 = pmin(dfaPN1a, 30, na.rm = TRUE))

FINAL7_new <- FINAL7_new %>% 
  mutate(
    P30 = if_else(PNEU30 < 30, 1L, 0L))


FINAL7_new <- FINAL7_new %>% 
  mutate(
    PNEU60 = pmin(dfaPN1a, 60, na.rm = TRUE))

FINAL7_new <- FINAL7_new %>% 
  mutate(
    P60 = if_else(PNEU60 < 60, 1L, 0L))


#mortality

FINAL7_new <- FINAL7_new %>% 
  mutate(
    DED30 = pmin(dfaDIED, 30, na.rm = TRUE))

FINAL7_new <- FINAL7_new %>% 
  mutate(
    D30yn = if_else(DED30 < 30, 1L, 0L))


FINAL7_new <- FINAL7_new %>% 
  mutate(
    DED60 = pmin(dfaDIED, 60, na.rm = TRUE))

FINAL7_new <- FINAL7_new %>% 
  mutate(
    D60yn = if_else(DED60 < 60, 1L, 0L))



#now clean up the data set!

FINAL_Analysis <- FINAL7_new %>% 
  select(ID, sex, Breed2, stp, BRTHW, SORCE, SD, DB, diaload, diaARR, LOAD, week, transitT, PN1a, PN2a, DIA1, D30, P30, P60, D30yn, D60yn, diaex, navelex, DIA30, PNEU30, PNEU60, Nav30, N30, DED30, DED60, Remark_PNEU1, Remark_SCOURS1, Remark_DIED1)

FINAL_Analysis <- FINAL_Analysis %>%
  mutate(SD_DB = paste(SD, DB, sep = "_"))

FINAL_Analysis <- FINAL_Analysis %>% 
  rename(CalfID = ID)

write.csv(x = FINAL_Analysis, file = "data/FINAL.csv")
  

#Scours

FINAL_Analysis %>% 
  filter(diaex == 0) %>% 
  group_by(SD) %>% 
  summarize(
    count = n(),
    prop_DIA = mean(DIA1, na.rm=TRUE), 
    sum_DIA  = sum(DIA1, na.rm=TRUE))

FINAL_Analysis %>% 
  filter(diaex == 0) %>% 
  group_by(SD, DB) %>% 
  summarize(
    count = n(),
    prop_DIA = mean(DIA1, na.rm=TRUE), 
    sum_DIA  = sum(DIA1, na.rm=TRUE))


FINAL_Analysis %>% 
  filter(diaex == 0) %>% 
  group_by(SD, DIA1) %>% 
  summarize(
    dfa_mean = mean(DIA30),
    dfa_sd   = sd(DIA30))

FINAL_Analysis %>% 
  filter(diaex == 0) %>% 
  group_by(Remark_SCOURS1, DB) %>% 
  summarize(
    count = n())


#Navel30
FINAL_Analysis %>% 
  filter(navelex == 1) %>% 
  group_by(SD) %>% 
  summarize(
    count = n())


FINAL_Analysis %>% 
  filter(navelex == 0) %>% 
  group_by(SD) %>% 
  summarize(
    count = n(),
    prop_Nav = mean(N30, na.rm=TRUE), 
    sum_Nav  = sum(N30, na.rm=TRUE))

FINAL_Analysis %>% 
  filter(navelex == 0) %>% 
  group_by(SD, DB) %>% 
  summarize(
    count = n(),
    prop_Nav = mean(N30, na.rm=TRUE), 
    sum_Nav  = sum(N30, na.rm=TRUE))


FINAL_Analysis %>% 
  filter(diaex == 0) %>% 
  group_by(SD, N30) %>% 
  summarize(
    dfa_mean = mean(Nav30),
    dfa_sd   = sd(Nav30))



#PNEU30


FINAL_Analysis %>% 
  group_by(SD) %>% 
  summarize(
    count = n(),
    prop_PN1 = mean(P30, na.rm=TRUE), 
    sum_PN1  = sum(P30, na.rm=TRUE))

FINAL_Analysis %>% 
  group_by(SD, DB) %>% 
  summarize(
    count = n(),
    prop_PN1 = mean(P30, na.rm=TRUE), 
    sum_PN1  = sum(P30, na.rm=TRUE))

FINAL_Analysis %>% 
  group_by(SD, PN1a) %>% 
  summarize(
    dfa_mean = mean(PNEU30),
    dfa_sd   = sd(PNEU30))

FINAL_Analysis %>% 
  filter(P60 == 1) %>% 
  group_by(Remark_PNEU1, DB) %>% 
  summarize(
    count = n())


#PNEU 60d
FINAL_Analysis %>% 
  group_by(SD) %>% 
  summarize(
    count = n(),
    prop_PN1 = mean(P60, na.rm=TRUE), 
    sum_PN1  = sum(P60, na.rm=TRUE))

FINAL_Analysis %>% 
  group_by(SD, DB) %>% 
  summarize(
    count = n(),
    prop_PN1 = mean(P60, na.rm=TRUE), 
    sum_PN1  = sum(P60, na.rm=TRUE))

FINAL_Analysis %>% 
  group_by(SD, PN1a) %>% 
  summarize(
    dfa_mean = mean(PNEU60),
    dfa_sd   = sd(PNEU60))

#MORTALITY
#30d mortality

FINAL_Analysis %>% 
  group_by(SD) %>% 
  summarize(
    count = n(),
    prop_DED1 = mean(D30yn, na.rm=TRUE), 
    sum_DED1  = sum(D30yn, na.rm=TRUE))

FINAL_Analysis %>% 
  group_by(SD, DB) %>% 
  summarize(
    count = n(),
    prop_DED1 = mean(D30yn, na.rm=TRUE), 
    sum_DED1  = sum(D30yn, na.rm=TRUE))

FINAL_Analysis %>% 
  group_by(SD, D30yn) %>% 
  summarize(
    dfa_mean = mean(DED30),
    dfa_sd   = sd(DED30))

FINAL_Analysis %>% 
  filter(D60yn == 1) %>% 
  group_by(Remark_DIED1) %>% 
  summarize(
    count = n())


#DEAD 60d
FINAL_Analysis %>% 
  group_by(SD) %>% 
  summarize(
    count = n(),
    prop_DED1 = mean(D60yn, na.rm=TRUE), 
    sum_DED1  = sum(D60yn, na.rm=TRUE))

FINAL_Analysis %>% 
  group_by(SD, DB) %>% 
  summarize(
    count = n(),
    prop_DED1 = mean(D60yn, na.rm=TRUE), 
    sum_DED1  = sum(D60yn, na.rm=TRUE))

FINAL_Analysis %>% 
  group_by(SD, D60yn) %>% 
  summarize(
    dfa_mean = mean(DED60),
    dfa_sd   = sd(DED60))

#How many calves treated for scours prior to transport were also treated for navel? Two by two frequency table? 

CrossTable (FINAL_Analysis$diaex, FINAL_Analysis$navelex)

#So, 416 were diarrhea only, 396 were navel only, and 4 were both. How to handle? 

CrossTable (FINAL_Analysis$DIA1, FINAL_Analysis$N30)

#29 had both a dia and NAV. 

CrossTable (FINAL_Analysis$diaex, FINAL_Analysis$P30)
CrossTable (FINAL_Analysis$diaex, FINAL_Analysis$P60)
CrossTable (FINAL_Analysis$diaex, FINAL_Analysis$D30yn)
CrossTable (FINAL_Analysis$diaex, FINAL_Analysis$D60yn)


CrossTable (FINAL_Analysis$navelex, FINAL_Analysis$P30)
CrossTable (FINAL_Analysis$navelex, FINAL_Analysis$P60)
CrossTable (FINAL_Analysis$navelex, FINAL_Analysis$D30yn)
CrossTable (FINAL_Analysis$navelex, FINAL_Analysis$D60yn)


```

#### Simple Demographic Univariable Analysis

```{r}
#| warning: false
#| echo: false

#Birth Weight

lm_bw <-lm(BRTHW ~ as.factor(SD), data=FINAL_Analysis)
summary(lm_bw)
anova(lm_bw )
emmeans(lm_bw, ~SD)

lm_bw <-lm(BRTHW ~ as.factor(SD)*as.factor(DB), data=FINAL_Analysis)
summary(lm_bw)
anova(lm_bw )
emmeans(lm_bw, ~SD|DB)

#STP
stp <- FINAL_Analysis %>% 
  filter(stp != 0)

lm_stp <-lm(stp ~ as.factor(SD), data=stp)
summary(lm_stp)
anova(lm_stp )
emmeans(lm_stp, ~SD)

lm_stp <-lm(stp ~ as.factor(SD)*as.factor(DB), data=stp)
summary(lm_stp)
anova(lm_stp )
emmeans(lm_stp, ~SD|DB)

#LoadAge

lm_load <-lm(diaload ~ as.factor(SD), data=FINAL_Analysis)
summary(lm_load)
anova(lm_load )
emmeans(lm_load, ~SD)

lm_load <-lm(diaload~ as.factor(SD)*as.factor(DB), data=FINAL_Analysis)
summary(lm_load)
anova(lm_load )
emmeans(lm_load, ~SD|DB)


#Arrival Age

lm_load <-lm(diaARR ~ as.factor(SD), data=FINAL_Analysis)
summary(lm_load)
anova(lm_load )
emmeans(lm_load, ~SD)

lm_load <-lm(diaARR~ as.factor(SD)*as.factor(DB), data=FINAL_Analysis)
summary(lm_load)
anova(lm_load )
emmeans(lm_load, ~SD|DB)

#Travel Time

lm_load <-lm(transitT ~ as.factor(SD), data=FINAL7_new)
summary(lm_load)
anova(lm_load )
emmeans(lm_load, ~SD)

lm_load <-lm(transitT ~ as.factor(SD)*as.factor(DB), data=FINAL7_new)
summary(lm_load)
anova(lm_load )
emmeans(lm_load, ~SD|DB)
```

### KM Curves for Morbidity and Mortality

#### Scours 30d

```{r}



#scours to 30d. 
FINAL_Analysis_filt <- FINAL_Analysis %>% 
  filter(diaex != 1)

surv_obj <- Surv(
  time  = FINAL_Analysis_filt$DIA30,
  event = FINAL_Analysis_filt$D30)

fit <- survfit(
  surv_obj ~ SD,
  data = FINAL_Analysis_filt)


custom_colors <- c(
  "SD=3"   = "red4", 
  "SD=3.5" = "goldenrod2", 
  "SD=4.5" = "wheat4")

ggsurvplot(
  fit,
  data = FINAL_Analysis_filt,
  palette = custom_colors,
  pval = TRUE,
  pval.coord = c(5, 0.6),
  conf.int = TRUE,
  risk.table = FALSE,
  xlab = "Time (days)",
  ylab = "Scours Treatment Survival Probability",
  xlim = c(0, 28),
  ylim = c(0.5, 1.0),
  legend = "top",
  break.time.by = 7)

table(FINAL_Analysis_filt$D30)






#scours to 30d.DAIRY vs. BEEF 
FINAL_Analysis_filt <- FINAL_Analysis %>% 
  filter(diaex != 1)

surv_obj <- Surv(
  time  = FINAL_Analysis_filt$DIA30,
  event = FINAL_Analysis_filt$D30)

fit <- survfit(
  surv_obj ~ DB,
  data = FINAL_Analysis_filt)

ggsurvplot(
  fit,
  data = FINAL_Analysis_filt,
  pval = TRUE,
  conf.int = TRUE,
  risk.table = FALSE,
  xlab = "Time (days)",
  ylab = "Scours Treatment Survival Probability",
  xlim = c(0, 28),
  ylim = c(0.5, 1.0),
  break.time.by = 7
)


table(FINAL_Analysis_filt$D30)

#What about by LOAD? 
FINAL_Analysis_filt <- FINAL_Analysis %>% 
  filter(diaex != 1)

surv_obj <- Surv(
  time  = FINAL_Analysis_filt$DIA30,
  event = FINAL_Analysis_filt$D30)

fit <- survfit(
  surv_obj ~ LOAD,
  data = FINAL_Analysis_filt)

ggsurvplot(
  fit,
  data = FINAL_Analysis_filt,
  pval = TRUE,
  conf.int = FALSE,
  risk.table = FALSE,
  xlab = "Time (days)",
  ylab = "Scours Treatment Survival Probability",
  xlim = c(0, 28),
  ylim = c(0.5, 1.0),
  break.time.by = 7, 
  legend = "none")

  
#yikes, a lot of variation by load. Will have to deal with that!

#What about by WEEK? 
FINAL_Analysis_filt <- FINAL_Analysis %>% 
  filter(diaex != 1)

surv_obj <- Surv(
  time  = FINAL_Analysis_filt$DIA30,
  event = FINAL_Analysis_filt$D30)

fit <- survfit(
  surv_obj ~ week,
  data = FINAL_Analysis_filt)

ggsurvplot(
  fit,
  data = FINAL_Analysis_filt,
  pval = TRUE,
  conf.int = FALSE,
  risk.table = FALSE,
  xlab = "Time (days)",
  ylab = "Scours Treatment Survival Probability",
  xlim = c(0, 28),
  ylim = c(0.5, 1.0),
  break.time.by = 7)




```

#### Navel 30d

```{r}

#Navel Infection to 30d. 
FINAL_Analysis_filt_n <- FINAL_Analysis %>% 
  filter(navelex != 1)

surv_obj <- Surv(
  time  = FINAL_Analysis_filt_n$Nav30,
  event = FINAL_Analysis_filt_n$N30)

fit <- survfit(
  surv_obj ~ SD,
  data = FINAL_Analysis_filt_n)

ggsurvplot(
  fit,
  data = FINAL_Analysis_filt_n,
  pval = TRUE,
  pval.coord = c(5, 0.9),
  conf.int = TRUE,
  risk.table = FALSE,
  xlab = "Time (days)",
  ylab = "Scours Treatment Survival Probability",
  xlim = c(0, 28),
  ylim = c(0.9, 1.0),
  break.time.by = 7)






#scours to 30d.DAIRY vs. BEEF 

surv_obj <- Surv(
  time  = FINAL_Analysis_filt_n$Nav30,
  event = FINAL_Analysis_filt_n$N30)

fit <- survfit(
  surv_obj ~ DB,
  data = FINAL_Analysis_filt_n)

ggsurvplot(
  fit,
  data = FINAL_Analysis_filt_n,
  pval = TRUE,
  pval.coord = c(5, 0.9),
  conf.int = TRUE,
  risk.table = FALSE,
  xlab = "Time (days)",
  ylab = "Scours Treatment Survival Probability",
  xlim = c(0, 28),
  ylim = c(0.9, 1.0),
  break.time.by = 7)

#LOAD

surv_obj <- Surv(
  time  = FINAL_Analysis_filt_n$Nav30,
  event = FINAL_Analysis_filt_n$N30)

fit <- survfit(
  surv_obj ~ LOAD,
  data = FINAL_Analysis_filt_n)

ggsurvplot(
  fit,
  data = FINAL_Analysis_filt_n,
  pval = TRUE,
  pval.coord = c(5, 0.9),
  conf.int = FALSE,
  risk.table = FALSE,
  xlab = "Time (days)",
  ylab = "Scours Treatment Survival Probability",
  xlim = c(0, 28),
  ylim = c(0.9, 1.0),
  legend = "none",
  break.time.by = 7)

#~5% variation by load. 


#WEEK

surv_obj <- Surv(
  time  = FINAL_Analysis_filt_n$Nav30,
  event = FINAL_Analysis_filt_n$N30)

fit <- survfit(
  surv_obj ~ week,
  data = FINAL_Analysis_filt_n)

ggsurvplot(
  fit,
  data = FINAL_Analysis_filt_n,
  pval = TRUE,
  pval.coord = c(5, 0.9),
  conf.int = FALSE,
  risk.table = FALSE,
  xlab = "Time (days)",
  ylab = "Scours Treatment Survival Probability",
  xlim = c(0, 28),
  ylim = c(0.9, 1.0),
  break.time.by = 7)

#~5% by week, week G was the worst. 




```

#### Resp 30d

```{r}


#resp to 30d. 

surv_obj <- Surv(
  time  = FINAL_Analysis$PNEU30,
  event = FINAL_Analysis$P30)

fit <- survfit(
  surv_obj ~ SD,
  data = FINAL_Analysis)

ggsurvplot(
  fit,
  data = FINAL_Analysis,
  pval = TRUE,
  pval.coord = c(5, 0.8),
  conf.int = TRUE,
  risk.table = FALSE,
  xlab = "Time (days)",
  ylab = "Resp Treatment Survival Probability",
  xlim = c(0, 28),
   ylim = c(0.75, 1.0),
  break.time.by = 7
)


table(FINAL_Analysis_filt$P30)





#resp to 30d. DAIRY vs. BEEF

surv_obj <- Surv(
  time  = FINAL_Analysis$PNEU30,
  event = FINAL_Analysis$P30)

fit <- survfit(
  surv_obj ~ DB,
  data = FINAL_Analysis)

ggsurvplot(
  fit,
  data = FINAL_Analysis,
  pval = TRUE,
  conf.int = TRUE,
  risk.table = FALSE,
  xlab = "Time (days)",
  ylab = "Survival Probability",
  xlim = c(0, 28),
  break.time.by = 7)

#by load

surv_obj <- Surv(
  time  = FINAL_Analysis$PNEU30,
  event = FINAL_Analysis$P30)

fit <- survfit(
  surv_obj ~ LOAD,
  data = FINAL_Analysis)

ggsurvplot(
  fit,
  data = FINAL_Analysis,
  pval = TRUE,
  conf.int = FALSE,
  risk.table = FALSE,
  xlab = "Time (days)",
  ylab = "Survival Probability",
  xlim = c(0, 28),
  legend = "none",
  break.time.by = 7)

#25% difference by load, likely also due to dairy vs. beef. 


#Week

surv_obj <- Surv(
  time  = FINAL_Analysis$PNEU30,
  event = FINAL_Analysis$P30)

fit <- survfit(
  surv_obj ~ week,
  data = FINAL_Analysis)

ggsurvplot(
  fit,
  data = FINAL_Analysis,
  pval = TRUE,
  conf.int = FALSE,
  risk.table = FALSE,
  xlab = "Time (days)",
  ylab = "Survival Probability",
  xlim = c(0, 28),
  break.time.by = 7)
```

#### Resp 60d

```{r}
#resp to 60d. 

surv_obj <- Surv(
  time  = FINAL_Analysis$PNEU60,
  event = FINAL_Analysis$P60)

fit <- survfit(
  surv_obj ~ SD,
  data = FINAL_Analysis)

ggsurvplot(
  fit,
  data = FINAL_Analysis,
  pval = TRUE,
   pval.coord = c(5, 0.8),
  conf.int = TRUE,
  risk.table = FALSE,
  xlab = "Time (days)",
  ylab = "Survival Probability",
  xlim = c(0, 60),
  ylim = c(0.5, 1.0),
  break.time.by = 7
)


table(FINAL_Analysis_filt$P60)



#DAIRY VS BEEF IN THE THUNDERDOME

surv_obj <- Surv(
  time  = FINAL_Analysis$PNEU60,
  event = FINAL_Analysis$P60)

fit <- survfit(
  surv_obj ~ DB,
  data = FINAL_Analysis)

ggsurvplot(
  fit,
  data = FINAL_Analysis,
  pval = TRUE,
  conf.int = TRUE,
  risk.table = FALSE,
  xlab = "Time (days)",
  ylab = "Survival Probability",
  xlim = c(0, 60),
  ylim = c(0.5, 1.0),
  break.time.by = 7
)


#By Load: 

surv_obj <- Surv(
  time  = FINAL_Analysis$PNEU60,
  event = FINAL_Analysis$P60)

fit <- survfit(
  surv_obj ~ LOAD,
  data = FINAL_Analysis)

ggsurvplot(
  fit,
  data = FINAL_Analysis,
  pval = TRUE,
   pval.coord = c(5, 0.8),
  conf.int = FALSE,
  risk.table = FALSE,
  xlab = "Time (days)",
  ylab = "Survival Probability",
  xlim = c(0, 60),
  ylim = c(0.5, 1.0),
  break.time.by = 7, 
  legend = "none")

#huge variation, likely driven by dairy vs. beef. 


#week
surv_obj <- Surv(
  time  = FINAL_Analysis$PNEU60,
  event = FINAL_Analysis$P60)

fit <- survfit(
  surv_obj ~ week,
  data = FINAL_Analysis)

ggsurvplot(
  fit,
  data = FINAL_Analysis,
  pval = TRUE,
   pval.coord = c(5, 0.8),
  conf.int = FALSE,
  risk.table = FALSE,
  xlab = "Time (days)",
  ylab = "Survival Probability",
  xlim = c(0, 60),
  ylim = c(0.5, 1.0),
  break.time.by = 7)

#Later calves did much worse (August -oct calves oof)

```

#### Death 30d

```{r}

#30d mortality 

surv_obj <- Surv(
  time  = FINAL_Analysis$DED30,
  event = FINAL_Analysis$D30yn)

fit <- survfit(
  surv_obj ~ SD,
  data = FINAL_Analysis)

ggsurvplot(
  fit,
  data = FINAL_Analysis,
  pval = TRUE,
  pval.coord = c(5, 0.95),
  conf.int = TRUE,
  risk.table = FALSE,
  xlab = "Time (days)",
  ylab = "Survival Probability",
  xlim = c(0, 28),
   ylim = c(0.9, 1.0),
  break.time.by = 7
)


table(FINAL_Analysis_filt$D30yn)


#30d mortality DAIRY VS. BEEFIES

surv_obj <- Surv(
  time  = FINAL_Analysis$DED30,
  event = FINAL_Analysis$D30yn)

fit <- survfit(
  surv_obj ~ DB,
  data = FINAL_Analysis)

ggsurvplot(
  fit,
  data = FINAL_Analysis,
  pval = TRUE,
  conf.int = TRUE,
  risk.table = FALSE,
  xlab = "Time (days)",
  ylab = "Survival Probability",
  xlim = c(0, 28),
  break.time.by = 7)


#By Load

surv_obj <- Surv(
  time  = FINAL_Analysis$DED30,
  event = FINAL_Analysis$D30yn)

fit <- survfit(
  surv_obj ~ LOAD,
  data = FINAL_Analysis)

ggsurvplot(
  fit,
  data = FINAL_Analysis,
  pval = TRUE,
  conf.int = FALSE,
  risk.table = FALSE,
  xlab = "Time (days)",
  ylab = "Survival Probability",
  xlim = c(0, 28),
   ylim = c(0.9, 1.0),
  break.time.by = 7, 
  legend = "none")

#maybe a 5ish percent difference? 


#By week

surv_obj <- Surv(
  time  = FINAL_Analysis$DED30,
  event = FINAL_Analysis$D30yn)

fit <- survfit(
  surv_obj ~ week,
  data = FINAL_Analysis)

ggsurvplot(
  fit,
  data = FINAL_Analysis,
  pval = TRUE,
  conf.int = FALSE,
  risk.table = FALSE,
  xlab = "Time (days)",
  ylab = "Survival Probability",
  xlim = c(0, 28),
   ylim = c(0.9, 1.0),
  break.time.by = 7)


```

#### Death 60d

```{r}

#60d mortality 

surv_obj <- Surv(
  time  = FINAL_Analysis$DED60,
  event = FINAL_Analysis$D60yn)

fit <- survfit(
  surv_obj ~ SD,
  data = FINAL_Analysis)

ggsurvplot(
  fit,
  data = FINAL_Analysis,
  pval = TRUE,
  pval.coord = c(5, 0.95),
  conf.int = TRUE,
  risk.table = FALSE,
  xlab = "Time (days)",
  ylab = "Survival Probability",
  xlim = c(0, 60),
     ylim = c(0.9, 1.0),
  break.time.by = 7
)


table(FINAL_Analysis_filt$D60yn)

#DAIRY VS BEEF 

surv_obj <- Surv(
  time  = FINAL_Analysis$DED60,
  event = FINAL_Analysis$D60yn)

fit <- survfit(
  surv_obj ~ DB,
  data = FINAL_Analysis)

ggsurvplot(
  fit,
  data = FINAL_Analysis,
  pval = TRUE,
  conf.int = TRUE,
  risk.table = FALSE,
  xlab = "Time (days)",
  ylab = "Survival Probability",
  xlim = c(0, 60),
  ylim = c(0.9, 1.0),
  break.time.by = 7)


#What about by load?
surv_obj <- Surv(
  time  = FINAL_Analysis$DED60,
  event = FINAL_Analysis$D60yn)

fit <- survfit(
  surv_obj ~ LOAD,
  data = FINAL_Analysis)

ggsurvplot(
  fit,
  data = FINAL_Analysis,
  pval = TRUE,
  conf.int = FALSE,
  risk.table = FALSE,
  xlab = "Time (days)",
  ylab = "Survival Probability",
  xlim = c(0, 60),
  ylim = c(0.9, 1.0),
  legend = "none",
  break.time.by = 7)

#doesn't seem like a lot of differece? 


#WEEK
surv_obj <- Surv(
  time  = FINAL_Analysis$DED60,
  event = FINAL_Analysis$D60yn)

fit <- survfit(
  surv_obj ~ week,
  data = FINAL_Analysis)

ggsurvplot(
  fit,
  data = FINAL_Analysis,
  pval = TRUE,
  conf.int = FALSE,
  risk.table = FALSE,
  xlab = "Time (days)",
  ylab = "Survival Probability",
  xlim = c(0, 60),
  ylim = c(0.9, 1.0),
  break.time.by = 7)

#3% difference

```

### KM Curves SDDB

#### Scours 30d

```{r}

FINAL_Analysis_filt <- FINAL_Analysis %>% 
  filter(diaex != 1)

surv_obj <- Surv(
  time  = FINAL_Analysis_filt$DIA30,
  event = FINAL_Analysis_filt$D30)

fit <- survfit(
  surv_obj ~ SD_DB,
  data = FINAL_Analysis_filt)

ggsurvplot(
  fit,
  data = FINAL_Analysis_filt,
  pval = TRUE,
  pval.coord = c(5, 0.6),
  conf.int = TRUE,
  risk.table = FALSE,
  xlab = "Time (days)",
  ylab = "Scours Treatment Survival Probability",
  xlim = c(0, 28),
  ylim = c(0.5, 1.0),
  break.time.by = 7)


#Dairy

FINAL_Analysis_filt_d <- FINAL_Analysis %>% 
  filter(diaex != 1) %>% 
  filter(Breed2 == "D")

surv_obj <- Surv(
  time  = FINAL_Analysis_filt_d$DIA30,
  event = FINAL_Analysis_filt_d$D30)

fit <- survfit(
  surv_obj ~ SD,
  data = FINAL_Analysis_filt_d)

custom_colors <- c(
  "SD=3"   = "red4", 
  "SD=3.5" = "goldenrod2", 
  "SD=4.5" = "wheat4")

ggsurvplot(
  fit,
  data = FINAL_Analysis_filt_d,
  palette = custom_colors,
  pval = TRUE,
  pval.coord = c(5, 0.6),
  conf.int = TRUE,
  risk.table = FALSE,
  xlab = "Time (days)",
  ylab = "Scours Treatment Survival Probability - DAIRY",
  xlim = c(0, 28),
  ylim = c(0.5, 1.0),
  break.time.by = 7)


#BEEF

FINAL_Analysis_filt_b <- FINAL_Analysis %>% 
  filter(diaex != 1) %>% 
  filter(Breed2 == "B")

surv_obj <- Surv(
  time  = FINAL_Analysis_filt_b$DIA30,
  event = FINAL_Analysis_filt_b$D30)

fit <- survfit(
  surv_obj ~ SD,
  data = FINAL_Analysis_filt_b)

ggsurvplot(
  fit,
  data = FINAL_Analysis_filt_b,
    palette = custom_colors,
  pval = TRUE,
  pval.coord = c(5, 0.6),
  conf.int = TRUE,
  risk.table = FALSE,
  xlab = "Time (days)",
  ylab = "Scours Treatment Survival Probability-BEEF",
  xlim = c(0, 28),
  ylim = c(0.5, 1.0),
  break.time.by = 7)


#What about M vs. Female? 
#FEMALE
FINAL_Analysis_filt_bf <- FINAL_Analysis_filt_b %>% 
   filter(diaex != 1) %>% 
    filter(sex == "F")

surv_obj <- Surv(
  time  = FINAL_Analysis_filt_bf$DIA30,
  event = FINAL_Analysis_filt_bf$D30)

fit <- survfit(
  surv_obj ~ SD,
  data = FINAL_Analysis_filt_bf)

ggsurvplot(
  fit,
  data = FINAL_Analysis_filt_bf,
  pval = TRUE,
  pval.coord = c(5, 0.6),
  conf.int = TRUE,
  risk.table = FALSE,
  xlab = "Time (days)",
  ylab = "Scours Treatment Survival Probability",
  xlim = c(0, 28),
  ylim = c(0.5, 1.0),
  break.time.by = 7)


#MALE
FINAL_Analysis_filt_bm <- FINAL_Analysis_filt_b %>% 
  filter(diaex != 1) %>% 
  filter(sex == "M")

surv_obj <- Surv(
  time  = FINAL_Analysis_filt_bm$DIA30,
  event = FINAL_Analysis_filt_bm$D30)

fit <- survfit(
  surv_obj ~ SD,
  data = FINAL_Analysis_filt_bm)

ggsurvplot(
  fit,
  data = FINAL_Analysis_filt_bm,
  pval = TRUE,
  pval.coord = c(5, 0.6),
  conf.int = TRUE,
  risk.table = FALSE,
  xlab = "Time (days)",
  ylab = "Scours Treatment Survival Probability",
  xlim = c(0, 28),
  ylim = c(0.5, 1.0),
  break.time.by = 7)



```

#### Navel 30

```{r}

FINAL_Analysis_filt_n <- FINAL_Analysis %>% 
  filter(navelex != 1)

custom_colors <- c(
  "SD=3"   = "red4", 
  "SD=3.5" = "goldenrod2", 
  "SD=4.5" = "wheat4")

surv_obj <- Surv(
  time  = FINAL_Analysis_filt_n$Nav30,
  event = FINAL_Analysis_filt_n$N30)

fit <- survfit(
  surv_obj ~ SD_DB,
  data = FINAL_Analysis_filt_n)

ggsurvplot(
  fit,
  data = FINAL_Analysis_filt_n,
  pval = TRUE,
  pval.coord = c(5, 0.95),
  conf.int = TRUE,
  risk.table = FALSE,
  xlab = "Time (days)",
  ylab = "Navel Treatment Survival Probability",
  xlim = c(0, 28),
  ylim = c(0.9, 1.0),
  break.time.by = 7)


#Dairy

FINAL_Analysis_filt_nd <- FINAL_Analysis_filt_n %>% 
  filter(navelex != 1) %>% 
  filter(Breed2 == "D")

surv_obj <- Surv(
  time  = FINAL_Analysis_filt_nd$Nav30,
  event = FINAL_Analysis_filt_nd$N30)

fit <- survfit(
  surv_obj ~ SD,
  data = FINAL_Analysis_filt_nd)

ggsurvplot(
  fit,
  data = FINAL_Analysis_filt_nd,
  palette = custom_colors,
  pval = TRUE,
  pval.coord = c(5, 0.95),
  conf.int = TRUE,
  risk.table = FALSE,
  xlab = "Time (days)",
  ylab = "Navel Treatment Survival Probability-DAIRY",
  xlim = c(0, 28),
  ylim = c(0.9, 1.0),
  break.time.by = 7)


#BEEF

FINAL_Analysis_filt_nb <- FINAL_Analysis_filt_n %>% 
  filter(navelex != 1) %>% 
  filter(Breed2 == "B")

surv_obj <- Surv(
  time  = FINAL_Analysis_filt_nb$Nav30,
  event = FINAL_Analysis_filt_nb$N30)

fit <- survfit(
  surv_obj ~ SD,
  data = FINAL_Analysis_filt_nb)

ggsurvplot(
  fit,
  data = FINAL_Analysis_filt_nb,
   palette = custom_colors,
  pval = TRUE,
  pval.coord = c(5, 0.95),
  conf.int = TRUE,
  risk.table = FALSE,
  xlab = "Time (days)",
  ylab = "Navel Treatment Survival Probability-BEEF",
  xlim = c(0, 28),
  ylim = c(0.9, 1.0),
  break.time.by = 7)


```

#### Resp 30d

```{r}


surv_obj <- Surv(
  time  = FINAL_Analysis$PNEU30,
  event = FINAL_Analysis$P30)

fit <- survfit(
  surv_obj ~ SD_DB,
  data = FINAL_Analysis)

ggsurvplot(
  fit,
  data = FINAL_Analysis,
  pval = TRUE,
  pval.coord = c(5, 0.8),
  conf.int = TRUE,
  risk.table = FALSE,
  xlab = "Time (days)",
  ylab = "Resp Treatment Survival Probability",
  xlim = c(0, 28),
   ylim = c(0.75, 1.0),
  break.time.by = 7)



#Dairy
FINAL_Analysis_d <- FINAL_Analysis %>% 
  filter(Breed2 == "D")

surv_obj <- Surv(
  time  = FINAL_Analysis_d$PNEU30,
  event = FINAL_Analysis_d$P30)

fit <- survfit(
  surv_obj ~ SD,
  data = FINAL_Analysis_d)

ggsurvplot(
  fit,
  data = FINAL_Analysis_d,
  pval = TRUE,
  pval.coord = c(5, 0.8),
  conf.int = TRUE,
  risk.table = FALSE,
  xlab = "Time (days)",
  ylab = "Resp Treatment Survival Probability",
  xlim = c(0, 28),
   ylim = c(0.75, 1.0),
  break.time.by = 7)


#Beef
FINAL_Analysis_b <- FINAL_Analysis %>% 
  filter(Breed2 == "B")


surv_obj <- Surv(
  time  = FINAL_Analysis_b$PNEU30,
  event = FINAL_Analysis_b$P30)

fit <- survfit(
  surv_obj ~ SD,
  data = FINAL_Analysis_b)

ggsurvplot(
  fit,
  data = FINAL_Analysis_b,
  pval = TRUE,
  pval.coord = c(5, 0.8),
  conf.int = TRUE,
  risk.table = FALSE,
  xlab = "Time (days)",
  ylab = "Resp Treatment Survival Probability",
  xlim = c(0, 28),
   ylim = c(0.75, 1.0),
  break.time.by = 7)

```

#### Resp 60d

```{r}

custom_colors <- c(
  "SD=3"   = "red4", 
  "SD=3.5" = "goldenrod2", 
  "SD=4.5" = "wheat4")


surv_obj <- Surv(
  time  = FINAL_Analysis$PNEU60,
  event = FINAL_Analysis$P60)

fit <- survfit(
  surv_obj ~ SD_DB,
  data = FINAL_Analysis)

ggsurvplot(
  fit,
  data = FINAL_Analysis,
  pval = TRUE,
   pval.coord = c(5, 0.8),
  conf.int = TRUE,
  risk.table = FALSE,
  xlab = "Time (days)",
  ylab = "Survival Probability",
  xlim = c(0, 60),
  ylim = c(0.5, 1.0),
  break.time.by = 7)


#Dairy
FINAL_Analysis_d <- FINAL_Analysis %>% 
  filter(Breed2 == "D")

surv_obj <- Surv(
  time  = FINAL_Analysis_d$PNEU60,
  event = FINAL_Analysis_d$P60)

fit <- survfit(
  surv_obj ~ SD,
  data = FINAL_Analysis_d)

ggsurvplot(
  fit,
  data = FINAL_Analysis_d,
  palette = custom_colors,
  pval = TRUE,
   pval.coord = c(5, 0.8),
  conf.int = TRUE,
  risk.table = FALSE,
  xlab = "Time (days)",
  ylab = "Respiratory Treatment Survival Probability - DAIRY",
  xlim = c(0, 60),
  ylim = c(0.5, 1.0),
  break.time.by = 7)

#Beef
FINAL_Analysis_b <- FINAL_Analysis %>% 
  filter(Breed2 == "B")

surv_obj <- Surv(
  time  = FINAL_Analysis_b$PNEU60,
  event = FINAL_Analysis_b$P60)

fit <- survfit(
  surv_obj ~ SD,
  data = FINAL_Analysis_b)

ggsurvplot(
  fit,
  data = FINAL_Analysis_b,
  palette = custom_colors,
  pval = TRUE,
   pval.coord = c(5, 0.8),
  conf.int = TRUE,
  risk.table = FALSE,
  xlab = "Time (days)",
  ylab = "Respiratory Treatment Survival Probability - BEEF",
  xlim = c(0, 60),
  ylim = c(0.5, 1.0),
  break.time.by = 7)

```

#### Death 30d

```{r}

custom_colors <- c(
  "SD=3"   = "red4", 
  "SD=3.5" = "goldenrod2", 
  "SD=4.5" = "wheat4")


surv_obj <- Surv(
  time  = FINAL_Analysis$DED30,
  event = FINAL_Analysis$D30yn)

fit <- survfit(
  surv_obj ~ SD_DB,
  data = FINAL_Analysis)

ggsurvplot(
  fit,
  data = FINAL_Analysis,
  pval = TRUE,
  pval.coord = c(5, 0.95),
  conf.int = TRUE,
  risk.table = FALSE,
  xlab = "Time (days)",
  ylab = "Survival Probability",
  xlim = c(0, 28),
   ylim = c(0.9, 1.0),
  break.time.by = 7)


#Dairy
FINAL_Analysis_d <- FINAL_Analysis %>% 
  filter(Breed2 == "D")

surv_obj <- Surv(
  time  = FINAL_Analysis_d$DED30,
  event = FINAL_Analysis_d$D30yn)

fit <- survfit(
  surv_obj ~ SD,
  data = FINAL_Analysis_d)

ggsurvplot(
  fit,
  data = FINAL_Analysis_d,
  palette = custom_colors,
  pval = TRUE,
  pval.coord = c(5, 0.95),
  conf.int = TRUE,
  risk.table = FALSE,
  xlab = "Time (days)",
  ylab = "Survival Probability - DAIRY",
  xlim = c(0, 28),
   ylim = c(0.9, 1.0),
  break.time.by = 7)


#BEEF
FINAL_Analysis_b <- FINAL_Analysis %>% 
  filter(Breed2 == "B")

surv_obj <- Surv(
  time  = FINAL_Analysis_b$DED30,
  event = FINAL_Analysis_b$D30yn)

fit <- survfit(
  surv_obj ~ SD,
  data = FINAL_Analysis_b)

ggsurvplot(
  fit,
  data = FINAL_Analysis_b,
  palette = custom_colors,
  pval = TRUE,
  pval.coord = c(5, 0.95),
  conf.int = TRUE,
  risk.table = FALSE,
  xlab = "Time (days)",
  ylab = "Survival Probability - BEEF",
  xlim = c(0, 28),
   ylim = c(0.9, 1.0),
  break.time.by = 7)



```

#### Death 60d

```{r}

custom_colors <- c(
  "SD=3"   = "red4", 
  "SD=3.5" = "goldenrod2", 
  "SD=4.5" = "wheat4")

surv_obj <- Surv(
  time  = FINAL_Analysis$DED60,
  event = FINAL_Analysis$D60yn)

fit <- survfit(
  surv_obj ~ SD_DB,
  data = FINAL_Analysis)

ggsurvplot(
  fit,
  data = FINAL_Analysis,
  pval = TRUE,
  pval.coord = c(5, 0.95),
  conf.int = TRUE,
  risk.table = FALSE,
  xlab = "Time (days)",
  ylab = "Survival Probability",
  xlim = c(0, 60),
     ylim = c(0.9, 1.0),
  break.time.by = 7)

#Dairy

FINAL_Analysis_d <- FINAL_Analysis %>% 
  filter(Breed2 == "D")

surv_obj <- Surv(
  time  = FINAL_Analysis_d$DED60,
  event = FINAL_Analysis_d$D60yn)

fit <- survfit(
  surv_obj ~ SD,
  data = FINAL_Analysis_d)

ggsurvplot(
  fit,
  data = FINAL_Analysis_d,
  palette = custom_colors,
  pval = TRUE,
  pval.coord = c(5, 0.95),
  conf.int = TRUE,
  risk.table = FALSE,
  xlab = "Time (days)",
  ylab = "Survival Probability - DAIRY",
  xlim = c(0, 60),
     ylim = c(0.9, 1.0),
  break.time.by = 7)


#Beef

FINAL_Analysis_b <- FINAL_Analysis %>% 
  filter(Breed2 == "B")

surv_obj <- Surv(
  time  = FINAL_Analysis_b$DED60,
  event = FINAL_Analysis_b$D60yn)

fit <- survfit(
  surv_obj ~ SD,
  data = FINAL_Analysis_b)

ggsurvplot(
  fit,
  data = FINAL_Analysis_b,
  palette = custom_colors,
  pval = TRUE,
  pval.coord = c(5, 0.95),
  conf.int = TRUE,
  risk.table = FALSE,
  xlab = "Time (days)",
  ylab = "Survival Probability - BEEF",
  xlim = c(0, 60),
     ylim = c(0.9, 1.0),
  break.time.by = 7)

```

### Cox Proportional Hazards Models

#### Scours 30d - FINAL

```{r}

FINAL_Analysis_filt <- FINAL_Analysis %>% 
  filter(diaex != 1) %>% 
  filter(navelex != 1)

FINAL_Analysis_filt$SD <- relevel(as.factor(FINAL_Analysis_filt$SD), ref = "3")

dia30_model <- coxme(Surv(DIA30, D30) ~ SD*DB  + transitT + BRTHW + diaARR + (1|week/LOAD), 
                   data = FINAL_Analysis_filt)
summary(dia30_model)
Anova(dia30_model, type = "III")

test_ph <- cox.zph(dia30_model)
print(test_ph)


plot(test_ph)
# Plot it (Flat line = assumption holds)

interaction_means <- emmeans(dia30_model, ~SD|DB)
sd_contrasts <- pairs(interaction_means, reverse = FALSE) 
summary(sd_contrasts, type = "response", infer = c(TRUE, TRUE))





```

#### Scours 30d - Dairy

##### Cox proportional with fraility

```{r}


FINAL_Analysis_filt_d <- FINAL_Analysis %>% 
  filter(diaex != 1) %>% 
  filter(Breed2 == "D")


FINAL_Analysis_filt_d$SD <- relevel(as.factor(FINAL_Analysis_filt_d$SD), ref = "3")

dia30_model <- coxph(Surv(DIA30, D30) ~ as.factor(SD) + diaARR + transitT + BRTHW +navelex, data = FINAL_Analysis_filt_d)

summary(dia30_model)
Anova(dia30_model, type = "III")

test_ph <- cox.zph(dia30_model)
print(test_ph)


plot(test_ph)


sd_means <- emmeans(dia30_model, "SD")
sd_contrasts <- pairs(sd_means, reverse = FALSE) 
summary(sd_contrasts, type = "response", infer = c(TRUE, TRUE))
```

##### Cox proportional with random effects

```{r}

FINAL_Analysis_filt_d <- FINAL_Analysis %>% 
  filter(diaex != 1) %>% 
  filter(Breed2 == "D")

scour_30 <- coxme(Surv(DIA30, D30) ~ as.factor(SD) +  diaARR + transitT + BRTHW + navelex + (1|week/LOAD), FINAL_Analysis_filt_d)

summary(scour_30, type=3)
Anova(scour_30, type = "III")



test_ph <- cox.zph(scour_30)
print(test_ph)
plot(test_ph)


sd_means <- emmeans(scour_30, "SD")
sd_contrasts <- pairs(sd_means, reverse = FALSE) 
summary(sd_contrasts, type = "response", infer = c(TRUE, TRUE))

adj_probs <- emmeans(scour_30, "SD", type = "response")
print(adj_probs)
```

#### Scours 30d - Beef

##### Cox proportional with no RE

```{r}

FINAL_Analysis_filt_b <- FINAL_Analysis %>% 
  filter(diaex != 1) %>% 
  filter(Breed2 == "B")

FINAL_Analysis_filt_b$SD <- relevel(as.factor(FINAL_Analysis_filt_b$SD), ref = "3")

dia30_model <- coxph(Surv(DIA30, D30) ~ as.factor(SD) + diaARR + BRTHW + LOAD + navelex, 
                   data = FINAL_Analysis_filt_b)
summary(dia30_model)

test_ph <- cox.zph(dia30_model)
print(test_ph)


plot(test_ph)

sd_means <- emmeans(dia30_model, "SD")
sd_contrasts <- pairs(sd_means, reverse = FALSE) 
summary(sd_contrasts, type = "response", infer = c(TRUE, TRUE))
```

##### Cox proportional with random effects

```{r}

FINAL_Analysis_filt_b <- FINAL_Analysis %>% 
  filter(diaex != 1) %>% 
  filter(Breed2 == "B")

scour_30w <- coxme(Surv(DIA30, D30) ~ as.factor(SD) +  diaARR + transitT + BRTHW + navelex + (1|week), FINAL_Analysis_filt_b)

summary(scour_30w, type=3)
Anova(scour_30w, type = "III")



test_ph <- cox.zph(scour_30w)
print(test_ph)
plot(test_ph)


sd_means <- emmeans(scour_30w, "SD")
sd_contrasts <- pairs(sd_means, reverse = FALSE) 
summary(sd_contrasts, type = "response", infer = c(TRUE, TRUE))





FINAL_Analysis_filt_b <- FINAL_Analysis %>% 
  filter(diaex != 1) %>% 
  filter(Breed2 == "B")

scour_30l <- coxme(Surv(DIA30, D30) ~ as.factor(SD) +  diaARR + transitT + BRTHW + navelex + (1|LOAD), FINAL_Analysis_filt_b)

summary(scour_30l, type=3)
Anova(scour_30l, type = "III")



test_ph <- cox.zph(scour_30l)
print(test_ph)
plot(test_ph)


sd_means <- emmeans(scour_30l, "SD")
sd_contrasts <- pairs(sd_means, reverse = FALSE) 
summary(sd_contrasts, type = "response", infer = c(TRUE, TRUE))




FINAL_Analysis_filt_b <- FINAL_Analysis %>% 
  filter(diaex != 1) %>% 
  filter(Breed2 == "B")

scour_30lw <- coxme(Surv(DIA30, D30) ~ as.factor(SD) +  diaARR + transitT + BRTHW + navelex + (1|week/LOAD), FINAL_Analysis_filt_b)

summary(scour_30lw, type=3)
Anova(scour_30lw, type = "III")



test_ph <- cox.zph(scour_30lw)
print(test_ph)
plot(test_ph)


sd_means <- emmeans(scour_30lw, "SD")
sd_contrasts <- pairs(sd_means, reverse = FALSE) 
summary(sd_contrasts, type = "response", infer = c(TRUE, TRUE))




print(scour_30l)
print(scour_30w)
print (scour_30lw)
```

#### Navel 30d - FINAL

```{r}

#NEED TO BACKWARDS STEPWISE THIS

FINAL_Analysis_filt_n <- FINAL_Analysis %>% 
  filter(navelex != 1) %>% 
  filter(diaex != 1)

FINAL_Analysis_filt_n$SD <- relevel(as.factor(FINAL_Analysis_filt_n$SD), ref = "3")

nav30_model <- coxme(Surv(Nav30, N30) ~ SD*DB  + transitT + diaARR + BRTHW + (1|week/LOAD), 
                   data = FINAL_Analysis_filt_n)
summary(nav30_model)
Anova(nav30_model, type = "III")

test_ph <- cox.zph(nav30_model)
print(test_ph)


plot(test_ph)
# Plot it (Flat line = assumption holds)

interaction_means <- emmeans(nav30_model, ~SD|DB)
sd_contrasts <- pairs(interaction_means, reverse = FALSE) 
summary(sd_contrasts, type = "response", infer = c(TRUE, TRUE))


```

#### Navel 30 - Dairy

```{r}

FINAL_Analysis_filt_nd <- FINAL_Analysis %>% 
  filter(navelex != 1) %>% 
  filter(Breed2 == "D")

FINAL_Analysis_filt_nd$SD <- relevel(as.factor(FINAL_Analysis_filt_nd$SD), ref = "3")

navel_30d <- coxme(Surv(Nav30, N30) ~ as.factor(SD) +  diaARR + transitT + BRTHW + diaex + (1|LOAD), FINAL_Analysis_filt_nd)

summary(navel_30d , type=3)
Anova(navel_30d , type = "III")



test_ph <- cox.zph(navel_30d )
print(test_ph)
plot(test_ph)


sd_means <- emmeans(navel_30d, "SD")
sd_contrasts <- pairs(sd_means, reverse = FALSE) 
summary(sd_contrasts, type = "response", infer = c(TRUE, TRUE))

```

#### Navel 30 - Beef

```{r}
FINAL_Analysis_filt_nb <- FINAL_Analysis %>% 
  filter(navelex != 1) %>% 
  filter(Breed2 == "B")

FINAL_Analysis_filt_nb$SD <- relevel(as.factor(FINAL_Analysis_filt_nb$SD), ref = "3")

navel_30b <- coxme(Surv(Nav30, N30) ~ as.factor(SD) +  diaARR + transitT + BRTHW + diaex + (1|LOAD), FINAL_Analysis_filt_nb)

summary(navel_30b , type=3)
Anova(navel_30b , type = "III")



test_ph <- cox.zph(navel_30b )
print(test_ph)
plot(test_ph)


sd_means <- emmeans(navel_30b, "SD")
sd_contrasts <- pairs(sd_means, reverse = FALSE) 
summary(sd_contrasts, type = "response", infer = c(TRUE, TRUE))
```

#### Resp 30d - ALL

Not sure this makes sense, there just aren't enough treatments in the dairy calves to mean anything. Could do just for beef during this time, or just present the model to 60d.

```{r}

FINAL_Analysis$SD <- relevel(as.factor(FINAL_Analysis$SD), ref = "3")

resp30_model <- coxph(Surv(PNEU30, P30) ~ SD*DB + diaARR + BRTHW, 
                   data = FINAL_Analysis)
summary(resp30_model)

test_ph <- cox.zph(resp30_model)
print(test_ph)


plot(test_ph)

sd_means <- emmeans(resp30_model, ~ SD)
sd_contrasts <- pairs(sd_means, reverse = FALSE) 
summary(sd_contrasts, type = "response", infer = c(TRUE, TRUE))
```

#### Resp 30d - Dairy

Only 2 observations here so this is a bit of a dumb model

```{r}

FINAL_Analysis_d <- FINAL_Analysis %>% 
  filter(Breed2 == "D")

FINAL_Analysis_d$SD <- relevel(as.factor(FINAL_Analysis_d$SD), ref = "3")

resp30_model <- coxph(Surv(PNEU30, P30) ~ as.factor(SD) + diaARR + BRTHW, 
                   data = FINAL_Analysis_d)
summary(resp30_model)


plot(test_ph)

#only 2 treatments, this is a stupid model

```

#### Resp 30d - Beef

```{r}
FINAL_Analysis_b <- FINAL_Analysis %>% 
  filter(Breed2 == "B")

FINAL_Analysis_b$SD <- relevel(as.factor(FINAL_Analysis_b$SD), ref = "3")

resp30_model <- coxph(Surv(PNEU30, P30) ~ as.factor(SD) + diaARR + BRTHW, 
                   data = FINAL_Analysis)
summary(resp30_model)

test_ph <- cox.zph(resp30_model)
print(test_ph)


plot(test_ph)

sd_means <- emmeans(resp30_model, "SD")
sd_contrasts <- pairs(sd_means, reverse = FALSE) 
summary(sd_contrasts, type = "response", infer = c(TRUE, TRUE))
```

#### Resp 60d - FINAL

```{r}

FINAL_Analysis$SD <- relevel(as.factor(FINAL_Analysis$SD), ref = "3")

resp60_model <- coxme(Surv(PNEU60, P60) ~ SD*DB + transitT + diaARR + BRTHW + navelex + diaex + (1|week/LOAD), data = FINAL_Analysis)

summary(resp60_model)
Anova(resp60_model, type = "III")

test_ph <- cox.zph(resp60_model)
print(test_ph)


plot(test_ph)

sd_means <- emmeans(resp60_model, ~ SD|DB)
sd_contrasts <- pairs(sd_means, reverse = FALSE) 
summary(sd_contrasts, type = "response", infer = c(TRUE, TRUE))


```

#### Resp 60d - Dairy

##### Regular Cox model

```{r}

FINAL_Analysis_d <- FINAL_Analysis %>% 
  filter(Breed2 == "D")

FINAL_Analysis_d$SD <- relevel(as.factor(FINAL_Analysis_d$SD), ref = "3")


resp60_model <- coxph(Surv(PNEU60, P60) ~ as.factor(SD) + diaARR + BRTHW + transitT + diaex + navelex, 
                   data = FINAL_Analysis_d)
summary(resp60_model)

test_ph <- cox.zph(resp60_model)
print(test_ph)


plot(test_ph)

sd_means <- emmeans(resp60_model, "SD")
sd_contrasts <- pairs(sd_means, reverse = FALSE) 
summary(sd_contrasts, type = "response", infer = c(TRUE, TRUE))
```

##### Cox model with random effects

```{r}

FINAL_Analysis_d <- FINAL_Analysis %>% 
  filter(Breed2 == "D")

FINAL_Analysis_d$SD <- relevel(as.factor(FINAL_Analysis_d$SD), ref = "3")

resp_60d <- coxme(Surv(PNEU60, P60) ~ as.factor(SD) +  diaARR + transitT + BRTHW + navelex + diaex + (1|LOAD), FINAL_Analysis_d)

summary(resp_60d, type=3)
Anova(resp_60d, type = "III")



test_ph <- cox.zph(resp_60d)
print(test_ph)
plot(test_ph)


sd_means <- emmeans(resp_60d, "SD")
sd_contrasts <- pairs(sd_means, reverse = FALSE) 
summary(sd_contrasts, type = "response", infer = c(TRUE, TRUE))

```

#### Resp 60d - Beef

##### Regular Cox Model

```{r}

FINAL_Analysis_b <- FINAL_Analysis %>% 
  filter(Breed2 == "B")

FINAL_Analysis_b$SD <- relevel(as.factor(FINAL_Analysis_b$SD), ref = "3")


resp60b_model <- coxph(Surv(PNEU60, P60) ~ as.factor(SD) + diaARR + BRTHW + transitT + diaex + navelex, 
                   data = FINAL_Analysis_b)
summary(resp60b_model)

test_ph <- cox.zph(resp60b_model)
print(test_ph)


plot(test_ph)

sd_means <- emmeans(resp60b_model, "SD")
sd_contrasts <- pairs(sd_means, reverse = FALSE) 
summary(sd_contrasts, type = "response", infer = c(TRUE, TRUE))
```

##### Cox model with random effects

```{r}
FINAL_Analysis_b <- FINAL_Analysis %>% 
  filter(Breed2 == "B")

FINAL_Analysis_b$SD <- relevel(as.factor(FINAL_Analysis_b$SD), ref = "3")

resp_60b <- coxme(Surv(PNEU60, P60) ~ as.factor(SD) +  diaARR + transitT + BRTHW + navelex + diaex + (1|LOAD), FINAL_Analysis_b)

summary(resp_60b, type=3)
Anova(resp_60b, type = "III")



test_ph <- cox.zph(resp_60b)
print(test_ph)
plot(test_ph)


sd_means <- emmeans(resp_60b, "SD")
sd_contrasts <- pairs(sd_means, reverse = FALSE) 
summary(sd_contrasts, type = "response", infer = c(TRUE, TRUE))
```

#### Death 30d - FINAL

```{r}

FINAL_Analysis$SD <- relevel(as.factor(FINAL_Analysis$SD), ref = "3")

dead30_model <- coxme(Surv(DED30, D30yn) ~ SD*DB + transitT + diaARR + BRTHW +diaex + navelex + (1|week/LOAD), 
                   data = FINAL_Analysis)
summary(dead30_model)
Anova(dead30_model, type = "III")

test_ph <- cox.zph(dead30_model)
print(test_ph)


plot(test_ph)

sd_means <- emmeans(dead30_model, ~ SD|DB)
sd_contrasts <- pairs(sd_means, reverse = FALSE) 
summary(sd_contrasts, type = "response", infer = c(TRUE, TRUE))



```

#### Death 30d - Dairy

##### Regular Cox Model

```{r}
FINAL_Analysis_d$SD <- relevel(as.factor(FINAL_Analysis_d$SD), ref = "3")

dead30_model <- coxph(Surv(DED60, D30yn) ~ SD + diaARR + BRTHW + navelex + diaex + transitT, 
                   data = FINAL_Analysis_d)
summary(dead30_model)

test_ph <- cox.zph(dead30_model)
print(test_ph)


plot(test_ph)

sd_means <- emmeans(dead30_model, "SD")
sd_contrasts <- pairs(sd_means, reverse = FALSE) 
summary(sd_contrasts, type = "response", infer = c(TRUE, TRUE))
```

##### Cox model with random effects

```{r}
FINAL_Analysis_d$SD <- relevel(as.factor(FINAL_Analysis_d$SD), ref = "3")

resp_60d <- coxme(Surv(DED30, D30yn) ~ as.factor(SD) +  diaARR + transitT + BRTHW +  navelex + diaex + (1|LOAD), FINAL_Analysis_d)

summary(resp_60d, type=3)
Anova(resp_60d, type = "III")



test_ph <- cox.zph(resp_60d)
print(test_ph)
plot(test_ph)


sd_means <- emmeans(resp_60d, "SD")
sd_contrasts <- pairs(sd_means, reverse = FALSE) 
summary(sd_contrasts, type = "response", infer = c(TRUE, TRUE))

```

#### Death 30d - Beef

##### Regular Cox Model

```{r}

FINAL_Analysis_b$SD <- relevel(as.factor(FINAL_Analysis_b$SD), ref = "3")

dead30_model <- coxph(Surv(DED30, D30yn) ~ SD + diaARR + transitT + BRTHW  + diaex + navelex, 
                   data = FINAL_Analysis_b)
summary(dead30_model)

test_ph <- cox.zph(dead30_model)
print(test_ph)


plot(test_ph)

sd_means <- emmeans(dead30_model, "SD")
sd_contrasts <- pairs(sd_means, reverse = FALSE) 
summary(sd_contrasts, type = "response", infer = c(TRUE, TRUE))
```

##### Cox model with random effects

```{r}
FINAL_Analysis_b$SD <- relevel(as.factor(FINAL_Analysis_b$SD), ref = "3")

dead_30b <- coxme(Surv(DED30, D30yn) ~ as.factor(SD) +  diaARR + BRTHW + transitT + navelex + diaex + (1|LOAD), FINAL_Analysis_b)

summary(dead_30b, type=3)
Anova(dead_30b, type = "III")



test_ph <- cox.zph(dead_30b)
print(test_ph)
plot(test_ph)


sd_means <- emmeans(dead_30b, "SD")
sd_contrasts <- pairs(sd_means, reverse = FALSE) 
summary(sd_contrasts, type = "response", infer = c(TRUE, TRUE))
```

#### Death 60d - FINAL

```{r}

FINAL_Analysis$SD <- relevel(as.factor(FINAL_Analysis$SD), ref = "3")

dead60_model <- coxme(Surv(DED60, D60yn) ~ SD*DB + diaARR + transitT + diaex + navelex + BRTHW + (1|week/LOAD), 
                   data = FINAL_Analysis)
summary(dead60_model)
Anova(dead60_model, type = "III")

test_ph <- cox.zph(dead30_model)
print(test_ph)


plot(test_ph)

sd_means <- emmeans(dead60_model, ~SD|DB)
sd_contrasts <- pairs(sd_means, reverse = FALSE) 
summary(sd_contrasts, type = "response", infer = c(TRUE, TRUE))


```

#### Death 60d - Dairy

##### Regular Cox Model

```{r}

FINAL_Analysis_d$SD <- relevel(as.factor(FINAL_Analysis_d$SD), ref = "3")

dead60_model <- coxph(Surv(DED60, D60yn) ~ SD + diaARR + BRTHW + transitT + diaex + navelex, 
                   data = FINAL_Analysis_d)
summary(dead60_model)

test_ph <- cox.zph(dead60_model)
print(test_ph)


plot(test_ph)

sd_means <- emmeans(dead60_model, "SD")
sd_contrasts <- pairs(sd_means, reverse = FALSE) 
summary(sd_contrasts, type = "response", infer = c(TRUE, TRUE))
```

##### Cox model with random effects

```{r}
FINAL_Analysis_d$SD <- relevel(as.factor(FINAL_Analysis_d$SD), ref = "3")

dead_60d <- coxme(Surv(DED60, D60yn) ~ as.factor(SD) +  diaARR + BRTHW + transitT + navelex + diaex + (1|LOAD), FINAL_Analysis_d)

summary(dead_60d, type=3)
Anova(dead_60d, type = "III")



test_ph <- cox.zph(dead_60d)
print(test_ph)
plot(test_ph)


sd_means <- emmeans(dead_60d, "SD")
sd_contrasts <- pairs(sd_means, reverse = FALSE) 
summary(sd_contrasts, type = "response", infer = c(TRUE, TRUE))
```

#### Death 60d - Beef

##### Regular Cox Model

```{r}
FINAL_Analysis_b$SD <- relevel(as.factor(FINAL_Analysis_b$SD), ref = "3")

dead60_model <- coxph(Surv(DED60, D60yn) ~ SD + diaARR + BRTHW + transitT + diaex + navelex, 
                   data = FINAL_Analysis_b)
summary(dead60_model)

test_ph <- cox.zph(dead60_model)
print(test_ph)


plot(test_ph)

sd_means <- emmeans(dead60_model, "SD")
sd_contrasts <- pairs(sd_means, reverse = FALSE) 
summary(sd_contrasts, type = "response", infer = c(TRUE, TRUE))
```

##### Cox model with random effects

```{r}
FINAL_Analysis_b$SD <- relevel(as.factor(FINAL_Analysis_b$SD), ref = "3")

dead_60b <- coxme(Surv(DED60, D60yn) ~ as.factor(SD) +  diaARR + BRTHW + transitT + navelex + diaex + (1|LOAD), FINAL_Analysis_b)

summary(dead_60b, type=3)
Anova(dead_60b, type = "III")



test_ph <- cox.zph(dead_60b)
print(test_ph)
plot(test_ph)


sd_means <- emmeans(dead_60b, "SD")
sd_contrasts <- pairs(sd_means, reverse = FALSE) 
summary(sd_contrasts, type = "response", infer = c(TRUE, TRUE))
```
